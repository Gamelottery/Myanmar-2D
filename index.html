<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myanmar 2D Lottery - မြန်မာ ၂လုံး ထီ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lottery-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .bet-card {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .bet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .upload-area.dragover {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
    </style>
</head><script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAcAMCXLexHyccOCJxWGxCcqlFcVX1UlMU",
    authDomain: "lottery-web-c7a5f.firebaseapp.com",
    projectId: "lottery-web-c7a5f",
    storageBucket: "lottery-web-c7a5f.firebasestorage.app",
    messagingSenderId: "530176543902",
    appId: "1:530176543902:web:d197d6038f32631fbbbf8f",
    measurementId: "G-6E09FJ49ZX"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
<body class="lottery-bg min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
            <!-- Login Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 text-white text-center">
                <div class="text-4xl mb-2">🎰</div>
                <h1 class="text-2xl font-bold mb-1">Myanmar 2D Lottery</h1>
                <p class="opacity-90">မြန်မာ ၂လုံး ထီ</p>
            </div>
            
            <!-- Login Form -->
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">🔐 အကောင့်ဝင်ရောက်ရန်</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">📱 ဖုန်းနံပါတ်</label>
                        <input type="tel" id="loginPhone" placeholder="09xxxxxxxxx" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                        <p class="text-xs text-gray-500 mt-1">ဥပမာ: 09123456789</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">🔑 လျှို့ဝှက်နံပါတ်</label>
                        <div class="relative">
                            <input type="password" id="loginPassword" placeholder="လျှို့ဝှက်နံပါတ် ထည့်ပါ" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg pr-12">
                            <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                👁️
                            </button>
                        </div>
                    </div>
                    
                    <button id="loginBtn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                        🚀 ဝင်ရောက်မည်
                    </button>
                </div>
                
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600 mb-3">အကောင့်မရှိသေးဘူးလား?</p>
                    <button id="showRegisterBtn" class="text-purple-600 hover:text-purple-800 font-medium underline">
                        📝 အကောင့်အသစ်ဖွင့်ရန်
                    </button>
                </div>
                
                <!-- Demo Accounts -->
                <div class="mt-6 bg-yellow-50 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-yellow-800 mb-2">🎯 စမ်းသုံးရန် အကောင့်များ</h3>
                    <div class="text-xs text-yellow-700 space-y-1">
                        <p><strong>User:</strong> 09123456789 / password: 123456</p>
                        <p><strong>VIP:</strong> 09987654321 / password: vip123</p>
                        <p><strong>Admin:</strong> 09750397287 / password: admin123</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="min-h-screen flex items-center justify-center px-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
            <!-- Register Header -->
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-6 text-white text-center">
                <div class="text-4xl mb-2">📝</div>
                <h1 class="text-2xl font-bold mb-1">အကောင့်အသစ်ဖွင့်ရန်</h1>
                <p class="opacity-90">New Account Registration</p>
            </div>
            
            <!-- Register Form -->
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">👤 အမည်</label>
                        <input type="text" id="registerName" placeholder="သင့်အမည် ထည့်ပါ" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">📱 ဖုန်းနံပါတ်</label>
                        <input type="tel" id="registerPhone" placeholder="09xxxxxxxxx" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg">
                        <p class="text-xs text-gray-500 mt-1">ဥပမာ: 09123456789</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">🔑 လျှို့ဝှက်နံပါတ်</label>
                        <input type="password" id="registerPassword" placeholder="အနည်းဆုံး ၆ လုံး" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">🔑 လျှို့ဝှက်နံပါတ် အတည်ပြုရန်</label>
                        <input type="password" id="confirmPassword" placeholder="လျှို့ဝှက်နံပါတ် ပြန်ထည့်ပါ" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg">
                    </div>
                    
                    <button id="registerBtn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                        ✅ အကောင့်ဖွင့်မည်
                    </button>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="showLoginBtn" class="text-green-600 hover:text-green-800 font-medium underline">
                        ⬅️ အကောင့်ဝင်ရောက်ရန် ပြန်သွားမည်
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden by default) -->
    <div id="mainApp" class="container mx-auto px-4 py-8 hidden">
        <!-- Header with User Profile -->
        <div class="bg-white rounded-2xl shadow-2xl mb-8 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-white bg-opacity-20 rounded-full p-2">
                            <span class="text-2xl">👤</span>
                        </div>
                        <div class="text-white">
                            <div class="font-bold text-lg" id="userDisplayName">Loading...</div>
                            <div class="text-sm opacity-90" id="userDisplayPhone">Loading...</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-white text-right">
                            <div class="text-xs opacity-75">လက်ကျန်ငွေ</div>
                            <div class="font-bold text-lg" id="userBalance">0 ကျပ်</div>
                        </div>
                        <button id="depositBtn" class="bg-green-500 bg-opacity-80 hover:bg-opacity-100 text-white p-2 rounded-lg transition-colors" title="ငွေသွင်း">
                            💰
                        </button>
                        <button id="withdrawBtn" class="bg-blue-500 bg-opacity-80 hover:bg-opacity-100 text-white p-2 rounded-lg transition-colors" title="ငွေထုတ်">
                            🏧
                        </button>
                        <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 rounded-lg transition-colors">
                            🚪
                        </button>
                    </div>
                </div>
            </div>
            <div class="text-center py-4">
                <h1 class="text-2xl font-bold text-gray-800 mb-1">🎰 Myanmar 2D Lottery</h1>
                <p class="text-gray-600">မြန်မာ ၂လုံး ထီ - ကံကောင်းပါစေ! 🍀</p>
            </div>
        </div>

        <!-- Lottery Results Display -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-4 text-white text-center">
                    <h2 class="text-2xl font-bold mb-1">🏆 ယနေ့ ထီရလဒ်များ</h2>
                    <p class="opacity-90" id="currentDate">Loading...</p>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- 9:30 AM Draw -->
                        <div class="text-center">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="text-lg font-bold text-blue-800 mb-2">🌅 မနက် 9:30</div>
                                <div class="bg-white rounded-lg p-4 shadow-inner">
                                    <div id="result930" class="text-3xl font-bold text-gray-400">မထွက်သေး</div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">Morning Draw</div>
                            </div>
                        </div>
                        
                        <!-- 2:00 PM Draw -->
                        <div class="text-center">
                            <div class="bg-green-50 rounded-lg p-4">
                                <div class="text-lg font-bold text-green-800 mb-2">☀️ နေ့လည် 2:00</div>
                                <div class="bg-white rounded-lg p-4 shadow-inner">
                                    <div id="result200" class="text-3xl font-bold text-gray-400">မထွက်သေး</div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">Afternoon Draw</div>
                            </div>
                        </div>
                        
                        <!-- 4:30 PM Draw -->
                        <div class="text-center">
                            <div class="bg-purple-50 rounded-lg p-4">
                                <div class="text-lg font-bold text-purple-800 mb-2">🌆 ညနေ 4:30</div>
                                <div class="bg-white rounded-lg p-4 shadow-inner">
                                    <div id="result430" class="text-3xl font-bold text-gray-400">မထွက်သေး</div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">Evening Draw</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Next Draw Countdown -->
                    <div class="mt-6 text-center">
                        <div class="bg-gray-100 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">နောက်ထီ ထွက်ချိန်</div>
                            <div id="nextDrawTime" class="text-lg font-bold text-orange-600">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Game Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 text-white text-center">
                <h2 class="text-2xl font-bold mb-2">🎯 ထီထိုးရန်</h2>
                <p class="opacity-90">နံပါတ်နှင့် ငွေပမာဏ ထည့်သွင်းပါ</p>
            </div>

            <!-- Number Entry Form -->
            <div class="p-6">
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">🎫 ထီထိုးရန် ထည့်သွင်းပါ</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">နံပါတ်</label>
                            <input type="text" id="numberInput" placeholder="ဥပမာ: 23" maxlength="2" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ငွေပမာဏ (ကျပ်)</label>
                            <input type="number" id="amountInput" placeholder="100" min="100" step="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-lg font-bold">
                        </div>
                        <div class="flex items-end">
                            <button id="addBetBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                ➕ ထည့်မည်
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bet List -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">📋 ထိုးထားသော ထီများ</h3>
                    <div id="betList" class="space-y-3 min-h-[100px]">
                        <div class="text-center text-gray-500 py-8">
                            <p>ထီမထိုးရသေးပါ</p>
                            <p class="text-sm">နံပါတ်နှင့် ငွေပမာဏ ထည့်ပြီး ထည့်မည် ကိုနှိပ်ပါ</p>
                        </div>
                    </div>
                </div>

                <!-- Total Amount -->
                <div class="bg-yellow-100 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-gray-800">💵 စုစုပေါင်း</span>
                        <span id="totalAmount" class="text-2xl font-bold text-green-600">0 ကျပ်</span>
                    </div>
                </div>

                <!-- Payment Button -->
                <button id="payNowBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-4 px-6 rounded-xl text-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-105" disabled>
                    🎯 ထီထိုးမည်
                </button>
            </div>
        </div>

        <!-- Deposit Modal -->
        <div id="depositModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-md mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-4 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">💰</span>
                            <span class="font-bold text-lg">ငွေသွင်းရန်</span>
                        </div>
                        <button id="closeDepositModal" class="text-white text-xl">✕</button>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Payment Method Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">💳 ငွေပေးချေမှု နည်းလမ်း ရွေးချယ်ပါ</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="selectWavePay" class="payment-method-btn bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg p-4 text-center transition-colors">
                                <div class="text-2xl mb-1">🌊</div>
                                <div class="text-sm font-bold text-blue-800">Wave Pay</div>
                            </button>
                            <button id="selectKPay" class="payment-method-btn bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-lg p-4 text-center transition-colors">
                                <div class="text-2xl mb-1">💜</div>
                                <div class="text-sm font-bold text-purple-800">K Pay</div>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">💵 သွင်းမည့် ငွေပမာဏ (ကျပ်)</label>
                        <input type="number" id="depositAmount" placeholder="ဥပမာ: 10000" min="1000" step="1000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg font-bold text-center">
                        <p class="text-xs text-gray-500 mt-1">အနည်းဆုံး ၁၀၀၀ ကျပ်</p>
                    </div>
                    
                    <!-- Quick Amount Buttons -->
                    <div class="mb-6">
                        <div class="text-sm font-medium text-gray-700 mb-2">⚡ လျင်မြန်သော ရွေးချယ်မှု</div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setDepositAmount(5000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                5,000
                            </button>
                            <button onclick="setDepositAmount(10000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                10,000
                            </button>
                            <button onclick="setDepositAmount(20000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                20,000
                            </button>
                            <button onclick="setDepositAmount(50000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                50,000
                            </button>
                            <button onclick="setDepositAmount(100000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                100,000
                            </button>
                            <button onclick="setDepositAmount(200000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                200,000
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="confirmDeposit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ✅ ငွေသွင်းမည်
                        </button>
                        <button id="cancelDeposit" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors">
                            ❌ ပယ်ဖျက်မည်
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Processing Modal -->
        <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-md mx-4 overflow-hidden">
                <div id="paymentHeader" class="p-4 text-white text-center">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span id="paymentIcon" class="text-2xl">🌊</span>
                            <span id="paymentTitle" class="font-bold text-lg">Wave Pay</span>
                        </div>
                        <button id="closePaymentModal" class="text-white text-xl">✕</button>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Payment Instructions -->
                    <div class="mb-6 bg-yellow-50 rounded-lg p-4">
                        <div class="text-sm text-yellow-800">
                            <div class="font-bold mb-2">📋 ငွေလွှဲရန် လမ်းညွှန်ချက်</div>
                            <div id="paymentInstructions" class="space-y-1 text-xs">
                                <!-- Instructions will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Amount Display -->
                    <div class="mb-4 bg-green-50 rounded-lg p-4 text-center">
                        <div class="text-sm text-green-700">လွှဲမည့် ငွေပမာဏ</div>
                        <div id="paymentAmount" class="text-2xl font-bold text-green-800">0 ကျပ်</div>
                    </div>

                    <!-- Transaction ID Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">📱 Transaction ID / Reference Number</label>
                        <input type="text" id="transactionId" placeholder="ဥပမာ: TXN123456789" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                        <p class="text-xs text-gray-500 mt-1">ငွေလွှဲပြီးနောက် ရရှိသော Transaction ID ကို ထည့်ပါ</p>
                    </div>

                    <!-- Screenshot Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">📸 Screenshot Upload (Optional)</label>
                        <div id="uploadArea" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="text-4xl mb-2">📱</div>
                            <div class="text-sm text-gray-600 mb-1">Screenshot ထည့်ရန် ဤနေရာကို နှိပ်ပါ</div>
                            <div class="text-xs text-gray-500">သို့မဟုတ် ဖိုင်ကို ဆွဲထည့်ပါ</div>
                            <input type="file" id="screenshotInput" accept="image/*" class="hidden">
                        </div>
                        <div id="uploadedFile" class="mt-2 text-sm text-green-600 hidden">
                            ✅ Screenshot ထည့်ပြီးပါပြီ
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="submitPayment" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ✅ ငွေလွှဲပြီးပါပြီ
                        </button>
                        <button id="cancelPayment" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors">
                            ❌ ပယ်ဖျက်မည်
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdraw Modal -->
        <div id="withdrawModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-md mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-4 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">🏧</span>
                            <span class="font-bold text-lg">ငွေထုတ်ရန်</span>
                        </div>
                        <button id="closeWithdrawModal" class="text-white text-xl">✕</button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="bg-yellow-100 rounded-lg p-3 mb-4">
                        <div class="text-sm text-yellow-800">
                            <div class="font-medium">💳 လက်ကျန်ငွေ: <span id="withdrawBalance">0 ကျပ်</span></div>
                        </div>
                    </div>

                    <!-- Payment Method Selection for Withdrawal -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">💳 ငွေထုတ်မည့် နည်းလမ်း ရွေးချယ်ပါ</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="selectWavePayWithdraw" class="withdraw-method-btn bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg p-4 text-center transition-colors">
                                <div class="text-2xl mb-1">🌊</div>
                                <div class="text-sm font-bold text-blue-800">Wave Pay</div>
                            </button>
                            <button id="selectKPayWithdraw" class="withdraw-method-btn bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-lg p-4 text-center transition-colors">
                                <div class="text-2xl mb-1">💜</div>
                                <div class="text-sm font-bold text-purple-800">K Pay</div>
                            </button>
                        </div>
                    </div>

                    <!-- Account Number Input -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">📱 အကောင့်နံပါတ်</label>
                        <input type="tel" id="withdrawAccountNumber" placeholder="09xxxxxxxxx" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                        <p class="text-xs text-gray-500 mt-1">ငွေလက်ခံမည့် Wave Pay / K Pay အကောင့်နံပါတ်</p>
                    </div>

                    <!-- Account Name Input -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">👤 အကောင့်ပိုင်ရှင် အမည်</label>
                        <input type="text" id="withdrawAccountName" placeholder="ဥပမာ: မောင်မောင်" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                        <p class="text-xs text-gray-500 mt-1">Wave Pay / K Pay တွင် မှတ်ပုံတင်ထားသော အမည်</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">💵 ထုတ်မည့် ငွေပမာဏ (ကျပ်)</label>
                        <input type="number" id="withdrawAmount" placeholder="ဥပမာ: 5000" min="1000" step="1000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-bold text-center">
                        <p class="text-xs text-gray-500 mt-1">အနည်းဆုံး ၁၀၀၀ ကျပ်</p>
                    </div>
                    
                    <!-- Quick Amount Buttons -->
                    <div class="mb-6">
                        <div class="text-sm font-medium text-gray-700 mb-2">⚡ လျင်မြန်သော ရွေးချယ်မှု</div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setWithdrawAmount(5000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                5,000
                            </button>
                            <button onclick="setWithdrawAmount(10000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                10,000
                            </button>
                            <button onclick="setWithdrawAmount(20000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                20,000
                            </button>
                            <button onclick="setWithdrawAmount(50000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                50,000
                            </button>
                            <button onclick="setWithdrawAmount(100000)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                100,000
                            </button>
                            <button onclick="setWithdrawAmount('all')" class="bg-red-100 hover:bg-red-200 text-red-800 font-bold py-2 px-3 rounded text-sm transition-colors">
                                အားလုံး
                            </button>
                        </div>
                    </div>

                    <!-- Withdrawal Notice -->
                    <div class="mb-6 bg-blue-50 rounded-lg p-4">
                        <div class="text-sm text-blue-800">
                            <div class="font-bold mb-2">⏰ ငွေထုတ်ခြင်း အချိန်ဇယား</div>
                            <div class="space-y-1 text-xs">
                                <div>• မနက် 9:00 - ညနေ 6:00 (တနင်္လာ - စနေ)</div>
                                <div>• ငွေထုတ်ခြင်း ၁-၂ နာရီ အတွင်း လုပ်ဆောင်ပေးပါမည်</div>
                                <div>• အပတ်စဉ် အများဆုံး ၅ ကြိမ် ထုတ်နိုင်ပါသည်</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="confirmWithdraw" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ✅ ငွေထုတ်တောင်းဆိုမည်
                        </button>
                        <button id="cancelWithdraw" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors">
                            ❌ ပယ်ဖျက်မည်
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-md mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-4 text-white text-center">
                    <h3 class="text-xl font-bold">📊 ထီထိုးမှု မှတ်တမ်း</h3>
                </div>
                
                <div class="p-6">
                    <div id="historyContent" class="space-y-4">
                        <!-- History items will be added here -->
                    </div>
                    
                    <button id="closeHistory" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors mt-4">
                        ပိတ်မည်
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Panel Modal -->
        <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-md mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-4 text-white text-center">
                    <h3 class="text-xl font-bold">🔐 Admin Panel</h3>
                </div>
                
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Admin Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter admin password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <div class="space-y-3">
                        <button id="loginAdmin" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            🔓 Login
                        </button>
                        <button id="closeAdmin" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors">
                            ❌ Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin History Modal -->
        <div id="adminHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-2xl mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-4 text-white">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold">👑 Admin Panel</h3>
                        <button id="closeAdminHistory" class="text-white text-xl">✕</button>
                    </div>
                </div>
                
                <div class="p-6 max-h-96 overflow-y-auto">
                    <!-- Lottery Results Control -->
                    <div class="mb-6 bg-yellow-50 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">🎰 ထီရလဒ် ထိန်းချုပ်မှု</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <!-- 9:30 AM Control -->
                            <div class="text-center">
                                <div class="text-sm font-medium text-blue-800 mb-2">မနက် 9:30</div>
                                <input type="text" id="admin930" placeholder="00-99" maxlength="2" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg font-bold">
                                <button onclick="setLotteryResult('09:30', 'admin930')" 
                                        class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-sm transition-colors">
                                    Set Result
                                </button>
                            </div>
                            
                            <!-- 2:00 PM Control -->
                            <div class="text-center">
                                <div class="text-sm font-medium text-green-800 mb-2">နေ့လည် 2:00</div>
                                <input type="text" id="admin200" placeholder="00-99" maxlength="2" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-center text-lg font-bold">
                                <button onclick="setLotteryResult('14:00', 'admin200')" 
                                        class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-sm transition-colors">
                                    Set Result
                                </button>
                            </div>
                            
                            <!-- 4:30 PM Control -->
                            <div class="text-center">
                                <div class="text-sm font-medium text-purple-800 mb-2">ညနေ 4:30</div>
                                <input type="text" id="admin430" placeholder="00-99" maxlength="2" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-lg font-bold">
                                <button onclick="setLotteryResult('16:30', 'admin430')" 
                                        class="w-full mt-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-2 rounded text-sm transition-colors">
                                    Set Result
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="clearAllResults()" 
                                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">
                                🗑️ Clear All Results
                            </button>
                        </div>
                    </div>
                    
                    <!-- Master Admin Control Status -->
                    <div class="bg-gradient-to-r from-red-500 to-pink-500 rounded-lg p-4 mb-6 text-white">
                        <h4 class="text-lg font-bold mb-4">👑 MASTER ADMIN CONTROL CENTER</h4>
                        
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-4">
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>🔥 Control Status:</span>
                                    <span class="font-bold text-green-300" id="adminControlStatus">ACTIVE</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>📱 Admin Device:</span>
                                    <span class="font-bold text-blue-300" id="adminDeviceInfo">Loading...</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>⚡ Last Update:</span>
                                    <span class="font-bold text-yellow-300" id="adminLastUpdate">Now</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>🌐 Connected Devices:</span>
                                    <span class="font-bold text-purple-300" id="connectedDevices">All</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>👥 Active Users:</span>
                                    <span class="font-bold text-orange-300" id="activeUsersCount">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="forceSyncAllDevices()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-2 px-4 rounded transition-colors">
                                🔄 FORCE SYNC ALL DEVICES
                            </button>
                        </div>
                    </div>

                    <!-- Admin Debug Panel -->
                    <div class="bg-red-50 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">🔧 Admin Debug Panel</h4>
                        
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button onclick="debugShowData()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded text-sm transition-colors">
                                📊 Show All Data
                            </button>
                            <button onclick="debugClearAllData()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded text-sm transition-colors">
                                🗑️ Clear All Data
                            </button>
                            <button onclick="debugReloadPage()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded text-sm transition-colors">
                                🔄 Reload Page
                            </button>
                            <button onclick="debugTestTransaction()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded text-sm transition-colors">
                                💰 Test Transaction
                            </button>
                        </div>
                        
                        <div class="text-xs text-gray-600 bg-white rounded p-2">
                            <div><strong>Current User:</strong> <span id="debugCurrentUser">None</span></div>
                            <div><strong>Total Users:</strong> <span id="debugTotalUsers">0</span></div>
                            <div><strong>Total Transactions:</strong> <span id="debugTotalTransactions">0</span></div>
                            <div><strong>Total History:</strong> <span id="debugTotalHistory">0</span></div>
                            <div><strong>Lottery Results:</strong> <span id="debugLotteryResults">None</span></div>
                            <div><strong>Master Control:</strong> <span id="debugMasterControl">Active</span></div>
                            <div><strong>Sync Status:</strong> <span id="debugSyncStatus">Connected</span></div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="bg-green-50 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">👥 အကောင့်များ စီမံခန့်ခွဲမှု</h4>
                        <div id="userManagementContent" class="space-y-3">
                            <!-- User management items will be added here -->
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-green-200">
                            <div class="flex gap-2">
                                <button onclick="makeAllUsersWin()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition-colors">
                                    🏆 အားလုံး အနိုင်ရစေမည်
                                </button>
                                <button onclick="resetAllUserBalances()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">
                                    💰 လက်ကျန်ငွေ Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Deposit/Withdrawal Approvals -->
                    <div class="bg-orange-50 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">💳 ငွေသွင်း/ထုတ် အတည်ပြုရန်</h4>
                        <div id="adminTransactionContent" class="space-y-4">
                            <!-- Admin transaction items will be added here -->
                        </div>
                    </div>

                    <!-- Pending Lottery Approvals -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">🎰 ထီထိုးမှု အတည်ပြုရန်</h4>
                        <div id="adminHistoryContent" class="space-y-4">
                            <!-- Admin history items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Buttons -->
        <div class="fixed bottom-6 right-6 space-y-3">
            <button id="historyBtn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full shadow-lg transition-colors block">
                📊
            </button>
            <button id="adminBtn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg transition-colors block relative">
                👑
                <div id="adminNotificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold hidden animate-pulse">
                    0
                </div>
            </button>
        </div>

        <!-- Admin Notification Panel -->
        <div id="adminNotificationPanel" class="fixed top-4 right-4 bg-white rounded-lg shadow-2xl border-2 border-red-500 max-w-sm w-full z-50 hidden">
            <div class="bg-gradient-to-r from-red-500 to-pink-500 p-3 text-white rounded-t-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">🔔</span>
                        <span class="font-bold">Admin Notifications</span>
                    </div>
                    <button id="closeNotificationPanel" class="text-white hover:text-gray-200 text-xl">✕</button>
                </div>
            </div>
            <div id="notificationContent" class="p-4 max-h-96 overflow-y-auto">
                <!-- Notifications will be added here -->
            </div>
            <div class="p-3 border-t bg-gray-50 rounded-b-lg">
                <button id="clearAllNotifications" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors">
                    🗑️ Clear All
                </button>
            </div>
        </div>
    </div>

    <script>
        // User Authentication System
        let currentUser = null;
        let users = [
            { phone: '09123456789', password: '123456', name: 'Mg Mg', balance: 50000, type: 'user' },
            { phone: '09987654321', password: 'vip123', name: 'Daw Aye', balance: 100000, type: 'vip' },
            { phone: '09750397287', password: 'admin123', name: 'Admin', balance: 999999, type: 'admin' }
        ];

        // Browser and Device Detection Functions
        function getBrowserInfo() {
            const userAgent = navigator.userAgent;
            let browser = 'Unknown';
            
            if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                browser = 'Chrome';
            } else if (userAgent.includes('Firefox')) {
                browser = 'Firefox';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                browser = 'Safari';
            } else if (userAgent.includes('Edg')) {
                browser = 'Edge';
            } else if (userAgent.includes('Opera') || userAgent.includes('OPR')) {
                browser = 'Opera';
            }
            
            return browser;
        }

        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let device = 'Desktop';
            
            if (/Android/i.test(userAgent)) {
                device = 'Android';
            } else if (/iPhone|iPad|iPod/i.test(userAgent)) {
                device = 'iOS';
            } else if (/Windows Phone/i.test(userAgent)) {
                device = 'Windows Phone';
            } else if (/Mobile/i.test(userAgent)) {
                device = 'Mobile';
            } else if (/Tablet/i.test(userAgent)) {
                device = 'Tablet';
            }
            
            return device;
        }

        function getLocationInfo() {
            // Get timezone as location indicator
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language || navigator.userLanguage;
            
            return {
                timezone: timezone,
                language: language,
                platform: navigator.platform
            };
        }

        // Game state
        let betList = [];
        let totalAmount = 0;
        let history = [];
        let transactionHistory = []; // For deposits and withdrawals
        let adminNotifications = []; // For admin notifications

        // Authentication Functions
        function validatePhone(phone) {
            const phoneRegex = /^09\d{7,9}$/;
            return phoneRegex.test(phone);
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        function findUser(phone, password) {
            return users.find(user => user.phone === phone && user.password === password);
        }

        function registerUser(name, phone, password) {
            // Check if user already exists
            if (users.find(user => user.phone === phone)) {
                return { success: false, message: 'ဤဖုန်းနံပါတ်ဖြင့် အကောင့်ရှိပြီးပါပြီ' };
            }

            // Create new user
            const newUser = {
                phone: phone,
                password: password,
                name: name,
                balance: 0, // Starting balance - no money for new users
                type: 'user',
                registeredAt: new Date().toLocaleString('my-MM'),
                browser: getBrowserInfo(),
                device: getDeviceInfo()
            };

            users.push(newUser);
            saveUsers(); // Save to localStorage
            
            // Notify admin of new registration
            notifyAdmin('newUser', {
                name: name,
                phone: phone,
                registeredAt: newUser.registeredAt,
                browser: newUser.browser,
                device: newUser.device
            });
            
            return { success: true, message: 'အကောင့်ဖွင့်ခြင်း အောင်မြင်ပါသည်!' };
        }

        function login(phone, password) {
            const user = findUser(phone, password);
            if (user) {
                currentUser = user;
                
                // Update user login info
                user.lastLogin = new Date().toLocaleString('my-MM');
                user.loginBrowser = getBrowserInfo();
                user.loginDevice = getDeviceInfo();
                user.loginCount = (user.loginCount || 0) + 1;
                
                saveUsers(); // Save updated user info
                saveCurrentUser(); // Save login state
                showMainApp();
                updateUserDisplay();
                
                // Notify admin of login (only for non-admin users)
                if (user.type !== 'admin') {
                    notifyAdmin('userLogin', {
                        name: user.name,
                        phone: user.phone,
                        loginTime: user.lastLogin,
                        browser: user.loginBrowser,
                        device: user.loginDevice,
                        loginCount: user.loginCount
                    });
                }
                
                return { success: true, message: 'အကောင့်ဝင်ရောက်ခြင်း အောင်မြင်ပါသည်!' };
            } else {
                return { success: false, message: 'ဖုန်းနံပါတ် သို့မဟုတ် လျှို့ဝှက်နံပါတ် မမှန်ကန်ပါ' };
            }
        }

        function logout() {
            currentUser = null;
            clearCurrentUser(); // Clear login state
            showLoginScreen();
            // Reset game state
            betList = [];
            totalAmount = 0;
            updateBetDisplay();
            updateTotal();
            updatePayButton();
        }

        // Save current user to localStorage
        function saveCurrentUser() {
            if (currentUser) {
                localStorage.setItem('lotteryCurrentUser', JSON.stringify({
                    phone: currentUser.phone,
                    loginTime: new Date().getTime()
                }));
            }
        }

        // Load current user from localStorage
        function loadCurrentUser() {
            const savedUser = localStorage.getItem('lotteryCurrentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const loginTime = userData.loginTime;
                const now = new Date().getTime();
                
                // Check if login is still valid (24 hours)
                if (now - loginTime < 24 * 60 * 60 * 1000) {
                    const user = users.find(u => u.phone === userData.phone);
                    if (user) {
                        currentUser = user;
                        return true;
                    }
                }
            }
            return false;
        }

        // Clear current user from localStorage
        function clearCurrentUser() {
            localStorage.removeItem('lotteryCurrentUser');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showRegisterScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userDisplayName').textContent = currentUser.name;
                document.getElementById('userDisplayPhone').textContent = currentUser.phone;
                document.getElementById('userBalance').textContent = currentUser.balance.toLocaleString() + ' ကျပ်';
                
                // Show/hide admin button based on user type
                const adminBtn = document.getElementById('adminBtn');
                if (currentUser.type === 'admin') {
                    adminBtn.style.display = 'block';
                } else {
                    adminBtn.style.display = 'none';
                }
            }
        }

        // Login/Register Event Listeners
        document.getElementById('loginBtn').addEventListener('click', function() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!phone || !password) {
                alert('ဖုန်းနံပါတ်နှင့် လျှို့ဝှက်နံပါတ် ထည့်ပါ');
                return;
            }

            if (!validatePhone(phone)) {
                alert('ဖုန်းနံပါတ် မှန်ကန်စွာ ထည့်ပါ (ဥပမာ: 09123456789)');
                return;
            }

            const result = login(phone, password);
            alert(result.message);

            if (result.success) {
                // Clear login form
                document.getElementById('loginPhone').value = '';
                document.getElementById('loginPassword').value = '';
            }
        });

        document.getElementById('registerBtn').addEventListener('click', function() {
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!name || !phone || !password || !confirmPassword) {
                alert('အချက်အလက်များ အားလုံး ထည့်ပါ');
                return;
            }

            if (!validatePhone(phone)) {
                alert('ဖုန်းနံပါတ် မှန်ကန်စွာ ထည့်ပါ (ဥပမာ: 09123456789)');
                return;
            }

            if (!validatePassword(password)) {
                alert('လျှို့ဝှက်နံပါတ် အနည်းဆုံး ၆ လုံး ရှိရမည်');
                return;
            }

            if (password !== confirmPassword) {
                alert('လျှို့ဝှက်နံပါတ်များ မတူညီပါ');
                return;
            }

            const result = registerUser(name, phone, password);
            
            if (result.success) {
                alert(`${result.message}\n\n⚠️ အကောင့်အသစ်များ လက်ကျန်ငွေ 0 ကျပ်ဖြင့် စတင်ပါသည်။\nထီထိုးရန် ငွေဖြည့်သွင်းပါ။\n\nအကောင့်ဝင်ရောက်ရန် Login စာမျက်နှာသို့ သွားပါ။`);
                
                // Clear register form
                document.getElementById('registerName').value = '';
                document.getElementById('registerPhone').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Go back to login screen instead of auto-login
                showLoginScreen();
            } else {
                alert(result.message);
            }
        });

        document.getElementById('showRegisterBtn').addEventListener('click', showRegisterScreen);
        document.getElementById('showLoginBtn').addEventListener('click', showLoginScreen);
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('အကောင့်မှ ထွက်မှာ သေချာပါသလား?')) {
                logout();
            }
        });

        // Password toggle
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleBtn = document.getElementById('togglePassword');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        });

        // Enter key support for login
        document.getElementById('loginPhone').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginPassword').focus();
            }
        });

        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });

        // Enter key support for register
        document.getElementById('registerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('registerPhone').focus();
            }
        });

        document.getElementById('registerPhone').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('registerPassword').focus();
            }
        });

        document.getElementById('registerPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('confirmPassword').focus();
            }
        });

        document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('registerBtn').click();
            }
        });

        // Add bet function
        function addBet() {
            const numberInput = document.getElementById('numberInput');
            const amountInput = document.getElementById('amountInput');
            
            const number = numberInput.value.trim();
            const amount = parseInt(amountInput.value);
            
            // Validation
            if (!number || number.length !== 2 || isNaN(parseInt(number))) {
                alert('နံပါတ် ၂ လုံး ရိုက်ထည့်ပါ (ဥပမာ: 23)');
                return;
            }
            
            if (!amount || amount < 100) {
                alert('ငွေပမာဏ အနည်းဆုံး ၁၀၀ ကျပ် ထည့်ပါ');
                return;
            }
            
            // Check if number already exists
            const existingBet = betList.find(bet => bet.number === number);
            if (existingBet) {
                existingBet.amount += amount;
            } else {
                betList.push({ number, amount, id: Date.now() });
            }
            
            // Clear inputs
            numberInput.value = '';
            amountInput.value = '';
            
            updateBetDisplay();
            updateTotal();
            updatePayButton();
        }

        // Remove bet function
        function removeBet(id) {
            betList = betList.filter(bet => bet.id !== id);
            updateBetDisplay();
            updateTotal();
            updatePayButton();
        }

        // Update bet display
        function updateBetDisplay() {
            const container = document.getElementById('betList');
            
            if (betList.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>ထီမထိုးရသေးပါ</p>
                        <p class="text-sm">နံပါတ်နှင့် ငွေပမာဏ ထည့်ပြီး ထည့်မည် ကိုနှိပ်ပါ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = betList.map(bet => `
                <div class="bet-card bg-white border rounded-lg p-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">
                            ${bet.number}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">${bet.amount.toLocaleString()} ကျပ်</div>
                            <div class="text-sm text-gray-600">နံပါတ် ${bet.number}</div>
                        </div>
                    </div>
                    <button onclick="removeBet(${bet.id})" class="text-red-500 hover:text-red-700 text-xl">
                        🗑️
                    </button>
                </div>
            `).join('');
        }

        // Update total
        function updateTotal() {
            totalAmount = betList.reduce((sum, bet) => sum + bet.amount, 0);
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' ကျပ်';
        }

        // Update pay button
        function updatePayButton() {
            const payBtn = document.getElementById('payNowBtn');
            payBtn.disabled = betList.length === 0;
        }



        // Add to history
        function addToHistory(bets, amount, status = 'လုပ်ဆောင်နေဆဲ', senderPhone = null) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toLocaleString('my-MM'),
                bets: [...bets],
                amount: amount,
                status: status,
                senderPhone: senderPhone,
                user: currentUser ? {
                    name: currentUser.name,
                    phone: currentUser.phone,
                    type: currentUser.type
                } : null
            };
            history.unshift(historyItem);
            saveHistory(); // Save to localStorage
            updateHistoryDisplay();
            updateAdminHistoryDisplay();
            
            // Notify admin of new bet
            notifyAdmin('newBet', {
                bets: bets,
                amount: amount,
                user: historyItem.user,
                senderPhone: senderPhone
            });
        }

        // Add transaction to history (deposits/withdrawals)
        function addTransactionToHistory(type, amount, method, details = {}, status = 'လုပ်ဆောင်နေဆဲ') {
            const transaction = {
                id: Date.now(),
                type: type, // 'deposit' or 'withdrawal'
                date: new Date().toLocaleString('my-MM'),
                amount: amount,
                method: method, // 'wavepay' or 'kpay'
                status: status,
                details: details,
                user: currentUser ? {
                    name: currentUser.name,
                    phone: currentUser.phone,
                    type: currentUser.type
                } : null
            };
            transactionHistory.unshift(transaction);
            saveTransactions(); // Save to localStorage
            updateTransactionHistoryDisplay();
            updateAdminTransactionDisplay();
            
            // Notify admin of new transaction
            notifyAdmin('newTransaction', {
                type: type,
                amount: amount,
                method: method,
                user: transaction.user,
                details: details
            });
        }

        // Approve transaction
        function approveTransaction(id) {
            const item = history.find(h => h.id === id);
            if (item) {
                item.status = 'အောင်မြင်ပါသည်';
                
                // If user exists, no need to refund (already deducted)
                saveHistory(); // Save to localStorage
                updateHistoryDisplay();
                updateAdminHistoryDisplay();
                
                alert(`Transaction approved for ${item.user ? item.user.name : 'Unknown User'}\nAmount: ${item.amount.toLocaleString()} ကျပ်`);
            }
        }

        // Reject transaction
        function rejectTransaction(id) {
            const item = history.find(h => h.id === id);
            if (item) {
                item.status = 'ပယ်ဖျက်ပြီး';
                
                // Refund balance to user if user exists
                if (item.user) {
                    const user = users.find(u => u.phone === item.user.phone);
                    if (user) {
                        user.balance += item.amount;
                        // Update display if it's the current user
                        if (currentUser && currentUser.phone === user.phone) {
                            currentUser.balance = user.balance;
                            updateUserDisplay();
                        }
                    }
                }
                
                saveUsers(); // Save to localStorage
                saveHistory(); // Save to localStorage
                updateHistoryDisplay();
                updateAdminHistoryDisplay();
                
                alert(`Transaction rejected and refunded for ${item.user ? item.user.name : 'Unknown User'}\nRefund: ${item.amount.toLocaleString()} ကျပ်`);
            }
        }

        // Approve deposit/withdrawal transaction
        function approveDepositWithdrawal(id) {
            try {
                const transaction = transactionHistory.find(t => t.id === id);
                if (!transaction) {
                    alert('Transaction not found!');
                    return;
                }
                
                transaction.status = 'အောင်မြင်ပါသည်';
                
                if (transaction.type === 'deposit') {
                    // Add money to user balance
                    if (transaction.user) {
                        const user = users.find(u => u.phone === transaction.user.phone);
                        if (user) {
                            user.balance += transaction.amount;
                            
                            // Update display if it's the current user
                            if (currentUser && currentUser.phone === user.phone) {
                                currentUser.balance = user.balance;
                                updateUserDisplay();
                            }
                            
                            console.log(`Added ${transaction.amount} to ${user.name}'s balance. New balance: ${user.balance}`);
                        }
                    }
                } else if (transaction.type === 'withdrawal') {
                    // Money already deducted, just approve
                    console.log(`Withdrawal approved for ${transaction.user?.name}: ${transaction.amount}`);
                }
                
                // Save changes immediately
                try {
                    saveUsers();
                    saveTransactions();
                } catch (e) {
                    console.log('Save error:', e);
                }
                
                // Update displays
                updateTransactionHistoryDisplay();
                updateAdminTransactionDisplay();
                updateUserManagementDisplay();
                
                const typeText = transaction.type === 'deposit' ? 'ငွေသွင်းမှု' : 'ငွေထုတ်မှု';
                const methodIcon = transaction.method === 'wavepay' ? '🌊' : '💜';
                const methodName = transaction.method === 'wavepay' ? 'Wave Pay' : 'K Pay';
                
                alert(`✅ ${typeText} အတည်ပြုပြီးပါပြီ!\n\n` +
                      `👤 အကောင့်ပိုင်ရှင်: ${transaction.user ? transaction.user.name : 'Unknown User'}\n` +
                      `📱 ဖုန်း: ${transaction.user ? transaction.user.phone : 'Unknown'}\n` +
                      `${methodIcon} နည်းလမ်း: ${methodName}\n` +
                      `💰 ငွေပမာဏ: ${transaction.amount.toLocaleString()} ကျပ်\n` +
                      `${transaction.details.transactionId ? `🔢 Transaction ID: ${transaction.details.transactionId}\n` : ''}` +
                      `${transaction.type === 'deposit' ? '✅ လက်ကျန်ငွေထဲ ထည့်ပေးပြီးပါပြီ!' : '✅ ငွေလွှဲပေးရန် စီစဉ်ပါ!'}`);
                
            } catch (error) {
                console.log('Approve transaction error:', error);
                alert('Error approving transaction. Please try again.');
            }
        }

        // Reject deposit/withdrawal transaction
        function rejectDepositWithdrawal(id) {
            try {
                const transaction = transactionHistory.find(t => t.id === id);
                if (!transaction) {
                    alert('Transaction not found!');
                    return;
                }
                
                const reason = prompt('ပယ်ဖျက်ရခြင်း အကြောင်းရင်း ရေးပါ (Optional):', '');
                
                transaction.status = 'ပယ်ဖျက်ပြီး';
                transaction.rejectReason = reason || 'No reason provided';
                
                if (transaction.type === 'withdrawal') {
                    // Refund balance to user for rejected withdrawal
                    if (transaction.user) {
                        const user = users.find(u => u.phone === transaction.user.phone);
                        if (user) {
                            user.balance += transaction.amount;
                            
                            // Update display if it's the current user
                            if (currentUser && currentUser.phone === user.phone) {
                                currentUser.balance = user.balance;
                                updateUserDisplay();
                            }
                            
                            console.log(`Refunded ${transaction.amount} to ${user.name}'s balance. New balance: ${user.balance}`);
                        }
                    }
                }
                // For deposits, no refund needed as money wasn't added yet
                
                // Save changes immediately
                try {
                    saveUsers();
                    saveTransactions();
                } catch (e) {
                    console.log('Save error:', e);
                }
                
                // Update displays
                updateTransactionHistoryDisplay();
                updateAdminTransactionDisplay();
                updateUserManagementDisplay();
                
                const typeText = transaction.type === 'deposit' ? 'ငွေသွင်းမှု' : 'ငွေထုတ်မှု';
                const methodIcon = transaction.method === 'wavepay' ? '🌊' : '💜';
                const methodName = transaction.method === 'wavepay' ? 'Wave Pay' : 'K Pay';
                const refundText = transaction.type === 'withdrawal' ? `\n💰 ငွေပြန်အမ်း: ${transaction.amount.toLocaleString()} ကျပ်` : '';
                
                alert(`❌ ${typeText} ပယ်ဖျက်ပြီးပါပြီ!\n\n` +
                      `👤 အကောင့်ပိုင်ရှင်: ${transaction.user ? transaction.user.name : 'Unknown User'}\n` +
                      `📱 ဖုန်း: ${transaction.user ? transaction.user.phone : 'Unknown'}\n` +
                      `${methodIcon} နည်းလမ်း: ${methodName}\n` +
                      `💰 ငွေပမာဏ: ${transaction.amount.toLocaleString()} ကျပ်\n` +
                      `${reason ? `📝 အကြောင်းရင်း: ${reason}\n` : ''}` +
                      `${refundText}`);
                
            } catch (error) {
                console.log('Reject transaction error:', error);
                alert('Error rejecting transaction. Please try again.');
            }
        }

        // Update history display
        function updateHistoryDisplay() {
            const container = document.getElementById('historyContent');
            
            // Combine lottery history and transaction history for user view
            const allHistory = [
                ...history.map(item => ({...item, type: 'lottery'})),
                ...transactionHistory.filter(t => !currentUser || t.user?.phone === currentUser.phone).map(item => ({...item, type: 'transaction'}))
            ].sort((a, b) => b.id - a.id);
            
            if (allHistory.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">မှတ်တမ်းမရှိပါ</p>';
                return;
            }
            
            container.innerHTML = allHistory.map(item => {
                if (item.type === 'lottery') {
                    // Check if this item has any winning bets
                    const hasWinnings = item.bets.some(bet => bet.isWinner);
                    const totalWinnings = item.bets.reduce((sum, bet) => {
                        return sum + (bet.isWinner ? bet.winAmount || 0 : 0);
                    }, 0);
                    
                    return `
                    <div class="border rounded-lg p-4 ${hasWinnings ? 'bg-yellow-50 border-yellow-300' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-sm text-gray-600">🎰 ${item.date}</div>
                            <div class="text-sm font-medium ${
                                item.status === 'လုပ်ဆောင်နေဆဲ' ? 'text-orange-600' : 
                                item.status === 'အောင်မြင်ပါသည်' ? 'text-green-600' : 'text-red-600'
                            }">
                                ${item.status}
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="text-sm text-gray-600 mb-1">ထိုးထားသော နံပါတ်များ:</div>
                            <div class="flex flex-wrap gap-1">
                                ${item.bets.map(bet => {
                                    const isWinner = bet.isWinner;
                                    const bgColor = isWinner ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                                    const winnerIcon = isWinner ? ' 🏆' : '';
                                    const drawTime = bet.winningDraw ? 
                                        (bet.winningDraw === '09:30' ? ' (မနက်)' : 
                                         bet.winningDraw === '14:00' ? ' (နေ့လည်)' : ' (ညနေ)') : '';
                                    
                                    return `<span class="${bgColor} px-2 py-1 rounded text-xs">${bet.number} (${bet.amount}ကျပ်)${winnerIcon}${drawTime}</span>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-600">ထိုးငွေ: ${item.amount.toLocaleString()} ကျပ်</div>
                            ${hasWinnings ? `<div class="font-bold text-green-600 text-lg">🎉 အနိုင်ရငွေ: ${totalWinnings.toLocaleString()} ကျပ်</div>` : ''}
                        </div>
                    </div>
                `;
                } else {
                    // Transaction history
                    const typeIcon = item.type === 'deposit' ? '💰' : '🏧';
                    const typeText = item.type === 'deposit' ? 'ငွေသွင်းမှု' : 'ငွေထုတ်မှု';
                    const methodIcon = item.method === 'wavepay' ? '🌊' : '💜';
                    const methodName = item.method === 'wavepay' ? 'Wave Pay' : 'K Pay';
                    
                    return `
                    <div class="border rounded-lg p-4 ${item.type === 'deposit' ? 'bg-green-50' : 'bg-blue-50'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-sm text-gray-600">${typeIcon} ${item.date}</div>
                            <div class="text-sm font-medium ${
                                item.status === 'လုပ်ဆောင်နေဆဲ' ? 'text-orange-600' : 
                                item.status === 'အောင်မြင်ပါသည်' ? 'text-green-600' : 'text-red-600'
                            }">
                                ${item.status}
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="text-sm font-medium text-gray-800">${typeText}</div>
                            <div class="text-sm text-gray-600">${methodIcon} ${methodName}</div>
                            ${item.details.transactionId ? `<div class="text-xs text-gray-500">Transaction ID: ${item.details.transactionId}</div>` : ''}
                            ${item.details.accountNumber ? `<div class="text-xs text-gray-500">အကောင့်: ${item.details.accountNumber}</div>` : ''}
                            ${item.details.accountName ? `<div class="text-xs text-gray-500">အမည်: ${item.details.accountName}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${item.type === 'deposit' ? 'text-green-600' : 'text-blue-600'}">
                                ${item.type === 'deposit' ? '+' : '-'}${item.amount.toLocaleString()} ကျပ်
                            </div>
                        </div>
                    </div>
                `;
                }
            }).join('');
        }

        // Update transaction history display (for users)
        function updateTransactionHistoryDisplay() {
            // This will be called to refresh the combined history display
            updateHistoryDisplay();
        }

        // Update admin history display
        function updateAdminHistoryDisplay() {
            const container = document.getElementById('adminHistoryContent');
            const pendingItems = history.filter(item => item.status === 'လုပ်ဆောင်နေဆဲ');
            
            if (pendingItems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Approve လုပ်ရန် မရှိပါ</p>';
                return;
            }
            
            container.innerHTML = pendingItems.map(item => `
                <div class="border rounded-lg p-4 bg-yellow-50">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm text-gray-600">${item.date}</div>
                        <div class="text-sm font-medium text-orange-600">
                            ${item.status}
                        </div>
                    </div>
                    ${item.user ? `
                    <div class="mb-2 bg-blue-50 rounded p-2">
                        <div class="text-sm text-gray-600">👤 အကောင့်ပိုင်ရှင်:</div>
                        <div class="text-sm font-medium text-blue-800">${item.user.name} (${item.user.phone})</div>
                        <div class="text-xs text-blue-600">${item.user.type === 'admin' ? 'Admin' : item.user.type === 'vip' ? 'VIP User' : 'Regular User'}</div>
                    </div>
                    ` : ''}
                    ${item.senderPhone ? `
                    <div class="mb-2">
                        <div class="text-sm text-gray-600">📱 လွှဲသူ ဖုန်းနံပါတ်:</div>
                        <div class="text-sm font-medium text-blue-600">${item.senderPhone}</div>
                    </div>
                    ` : ''}
                    <div class="mb-3">
                        <div class="text-sm text-gray-600 mb-1">ထိုးထားသော နံပါတ်များ:</div>
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${item.bets.map(bet => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${bet.number} (${bet.amount}ကျပ်)</span>`).join('')}
                        </div>
                        <div class="text-right font-bold text-green-600">${item.amount.toLocaleString()} ကျပ်</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="approveTransaction(${item.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            ✅ Approve
                        </button>
                        <button onclick="rejectTransaction(${item.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            ❌ Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update admin transaction display (for deposits/withdrawals)
        function updateAdminTransactionDisplay() {
            const container = document.getElementById('adminTransactionContent');
            const pendingTransactions = transactionHistory.filter(t => t.status === 'လုပ်ဆောင်နေဆဲ');
            
            if (pendingTransactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">အတည်ပြုရန် ငွေသွင်း/ထုတ် မရှိပါ</p>';
                return;
            }
            
            container.innerHTML = pendingTransactions.map(transaction => {
                const typeIcon = transaction.type === 'deposit' ? '💰' : '🏧';
                const typeText = transaction.type === 'deposit' ? 'ငွေသွင်းမှု' : 'ငွေထုတ်မှု';
                const methodIcon = transaction.method === 'wavepay' ? '🌊' : '💜';
                const methodName = transaction.method === 'wavepay' ? 'Wave Pay' : 'K Pay';
                const bgColor = transaction.type === 'deposit' ? 'bg-green-50' : 'bg-blue-50';
                
                return `
                <div class="border rounded-lg p-4 ${bgColor}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm text-gray-600">${typeIcon} ${transaction.date}</div>
                        <div class="text-sm font-medium text-orange-600">
                            ${transaction.status}
                        </div>
                    </div>
                    
                    ${transaction.user ? `
                    <div class="mb-3 bg-white rounded p-3">
                        <div class="text-sm text-gray-600">👤 အကောင့်ပိုင်ရှင်:</div>
                        <div class="text-sm font-medium text-gray-800">${transaction.user.name} (${transaction.user.phone})</div>
                        <div class="text-xs text-gray-600">${transaction.user.type === 'admin' ? 'Admin' : transaction.user.type === 'vip' ? 'VIP User' : 'Regular User'}</div>
                    </div>
                    ` : ''}
                    
                    <div class="mb-3">
                        <div class="text-lg font-bold text-gray-800 mb-2">${typeText}</div>
                        <div class="text-sm text-gray-600 mb-1">${methodIcon} ${methodName}</div>
                        
                        ${transaction.details.transactionId ? `
                        <div class="bg-yellow-100 rounded p-2 mb-2">
                            <div class="text-xs text-yellow-800 font-medium">Transaction ID:</div>
                            <div class="text-sm font-mono text-yellow-900">${transaction.details.transactionId}</div>
                        </div>
                        ` : ''}
                        
                        ${transaction.details.accountNumber ? `
                        <div class="text-xs text-gray-600">လက်ခံမည့် အကောင့်: ${transaction.details.accountNumber}</div>
                        ` : ''}
                        
                        ${transaction.details.accountName ? `
                        <div class="text-xs text-gray-600">အကောင့်ပိုင်ရှင်: ${transaction.details.accountName}</div>
                        ` : ''}
                        
                        ${transaction.details.screenshot ? `
                        <div class="text-xs text-green-600 mt-1">📸 Screenshot ပါဝင်သည်</div>
                        ` : ''}
                    </div>
                    
                    <div class="mb-3 text-center">
                        <div class="text-2xl font-bold ${transaction.type === 'deposit' ? 'text-green-600' : 'text-blue-600'}">
                            ${transaction.type === 'deposit' ? '+' : '-'}${transaction.amount.toLocaleString()} ကျပ်
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="approveDepositWithdrawal(${transaction.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            ✅ အတည်ပြုမည်
                        </button>
                        <button onclick="rejectDepositWithdrawal(${transaction.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            ❌ ပယ်ဖျက်မည်
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Update user management display
        function updateUserManagementDisplay() {
            const container = document.getElementById('userManagementContent');
            const regularUsers = users.filter(user => user.type !== 'admin');
            
            if (regularUsers.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">အကောင့်များ မရှိပါ</p>';
                return;
            }
            
            container.innerHTML = regularUsers.map(user => {
                const isOnline = isUserOnline(user);
                const onlineStatus = isOnline ? 
                    '<span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> <span class="text-green-600 text-xs">Online</span>' : 
                    '<span class="inline-block w-2 h-2 bg-gray-400 rounded-full"></span> <span class="text-gray-500 text-xs">Offline</span>';
                
                return `
                <div class="border rounded-lg p-3 bg-white ${isOnline ? 'border-green-200 bg-green-50' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="font-medium text-gray-800">${user.name}</div>
                                ${onlineStatus}
                            </div>
                            <div class="text-sm text-gray-600">${user.phone}</div>
                            <div class="text-xs ${user.type === 'vip' ? 'text-purple-600' : 'text-blue-600'}">${user.type === 'vip' ? 'VIP User' : 'Regular User'}</div>
                            
                            <!-- Device & Browser Info -->
                            <div class="mt-2 text-xs text-gray-500 space-y-1">
                                ${user.registeredAt ? `<div>📅 မှတ်ပုံတင်: ${user.registeredAt}</div>` : ''}
                                ${user.lastLogin ? `<div>🕐 နောက်ဆုံးဝင်: ${user.lastLogin}</div>` : ''}
                                ${user.loginBrowser ? `<div>🌐 Browser: ${user.loginBrowser}</div>` : ''}
                                ${user.loginDevice ? `<div>📱 Device: ${user.loginDevice}</div>` : ''}
                                ${user.loginCount ? `<div>🔢 Login အကြိမ်: ${user.loginCount}</div>` : ''}
                                ${user.lastActivity ? `<div>⚡ နောက်ဆုံး Active: ${user.lastActivity}</div>` : ''}
                                <div class="text-xs ${isOnline ? 'text-green-600' : 'text-gray-400'}">
                                    🌐 Cross-Device Sync: ${isOnline ? 'Connected' : 'Offline'}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">လက်ကျန်ငွေ</div>
                            <div class="font-bold text-green-600">${user.balance.toLocaleString()} ကျပ်</div>
                        </div>
                    </div>
                    <div class="flex gap-1 justify-end">
                        <button onclick="addUserBalance('${user.phone}', 10000)" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded">
                            +10K
                        </button>
                        <button onclick="makeUserWin('${user.phone}')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded">
                            🏆 Win
                        </button>
                        <button onclick="viewUserDetails('${user.phone}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded">
                            👁️ View
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Check if user is currently online
        function isUserOnline(user) {
            if (!user.lastLogin) return false;
            
            // Consider user online if they logged in within last 5 minutes
            const lastLoginTime = new Date(user.lastLogin).getTime();
            const now = new Date().getTime();
            const fiveMinutes = 5 * 60 * 1000;
            
            return (now - lastLoginTime) < fiveMinutes;
        }

        // View user details
        function viewUserDetails(phone) {
            const user = users.find(u => u.phone === phone);
            if (!user) return;
            
            const location = getLocationInfo();
            const isOnline = isUserOnline(user);
            
            let details = `👤 အကောင့်အသေးစိတ်\n\n`;
            details += `📛 အမည်: ${user.name}\n`;
            details += `📱 ဖုန်း: ${user.phone}\n`;
            details += `💰 လက်ကျန်ငွေ: ${user.balance.toLocaleString()} ကျပ်\n`;
            details += `🏷️ အမျိုးအစား: ${user.type === 'vip' ? 'VIP User' : 'Regular User'}\n`;
            details += `🟢 အခြေအနေ: ${isOnline ? 'Online' : 'Offline'}\n\n`;
            
            if (user.registeredAt) {
                details += `📅 မှတ်ပုံတင်ချိန်: ${user.registeredAt}\n`;
                details += `🌐 မှတ်ပုံတင် Browser: ${user.browser || 'Unknown'}\n`;
                details += `📱 မှတ်ပုံတင် Device: ${user.device || 'Unknown'}\n\n`;
            }
            
            if (user.lastLogin) {
                details += `🕐 နောက်ဆုံးဝင်ချိန်: ${user.lastLogin}\n`;
                details += `🌐 နောက်ဆုံး Browser: ${user.loginBrowser || 'Unknown'}\n`;
                details += `📱 နောက်ဆုံး Device: ${user.loginDevice || 'Unknown'}\n`;
                details += `🔢 Login အကြိမ်: ${user.loginCount || 0}\n\n`;
            }
            
            // Show user's betting history
            const userBets = history.filter(h => h.user && h.user.phone === phone);
            if (userBets.length > 0) {
                details += `🎰 ထီထိုးမှု မှတ်တမ်း: ${userBets.length} ကြိမ်\n`;
                const totalBetAmount = userBets.reduce((sum, bet) => sum + bet.amount, 0);
                details += `💵 စုစုပေါင်း ထိုးငွေ: ${totalBetAmount.toLocaleString()} ကျပ်\n`;
            }
            
            // Show user's transaction history
            const userTransactions = transactionHistory.filter(t => t.user && t.user.phone === phone);
            if (userTransactions.length > 0) {
                const deposits = userTransactions.filter(t => t.type === 'deposit');
                const withdrawals = userTransactions.filter(t => t.type === 'withdrawal');
                details += `💰 ငွေသွင်းမှု: ${deposits.length} ကြိမ်\n`;
                details += `🏧 ငွေထုတ်မှု: ${withdrawals.length} ကြိမ်\n`;
            }
            
            alert(details);
        }

        // Admin user management functions
        function addUserBalance(phone, amount) {
            const user = users.find(u => u.phone === phone);
            if (user) {
                user.balance += amount;
                
                // Update display if it's the current user
                if (currentUser && currentUser.phone === phone) {
                    currentUser.balance = user.balance;
                    updateUserDisplay();
                }
                
                saveUsers(); // Save to localStorage
                updateUserManagementDisplay();
                alert(`${user.name} ၏ လက်ကျန်ငွေ ${amount.toLocaleString()} ကျပ် ထပ်ထည့်ပေးပြီးပါပြီ!\nလက်ကျန်ငွေ: ${user.balance.toLocaleString()} ကျပ်`);
            }
        }

        function makeUserWin(phone) {
            const user = users.find(u => u.phone === phone);
            if (!user) return;
            
            // Find user's pending bets
            const userBets = history.filter(item => 
                item.user && item.user.phone === phone && item.status === 'အောင်မြင်ပါသည်'
            );
            
            if (userBets.length === 0) {
                alert(`${user.name} ၏ ထီထိုးမှု မရှိပါ`);
                return;
            }
            
            // Get the latest bet
            const latestBet = userBets[0];
            
            if (latestBet.bets.length === 0) {
                alert(`${user.name} ၏ ထီနံပါတ် မရှိပါ`);
                return;
            }
            
            // Use the first number from their latest bet
            const winningNumber = latestBet.bets[0].number;
            
            // Set this number as the next available draw result
            let nextDrawTime = null;
            for (let time of ['09:30', '14:00', '16:30']) {
                if (!todayResults[time]) {
                    nextDrawTime = time;
                    break;
                }
            }
            
            if (!nextDrawTime) {
                // Clear all results and use first slot
                todayResults = {
                    '09:30': null,
                    '14:00': null,
                    '16:30': null
                };
                nextDrawTime = '09:30';
            }
            
            // Set the winning number
            todayResults[nextDrawTime] = winningNumber;
            
            // Calculate winnings (80x multiplier)
            const totalWinnings = latestBet.bets.reduce((sum, bet) => {
                if (bet.number === winningNumber) {
                    return sum + (bet.amount * 80);
                }
                return sum;
            }, 0);
            
            // Add winnings to user balance
            user.balance += totalWinnings;
            
            // Update display if it's the current user
            if (currentUser && currentUser.phone === phone) {
                currentUser.balance = user.balance;
                updateUserDisplay();
            }
            
            // Save changes to localStorage
            saveUsers();
            saveLotteryResults();
            
            // Update lottery display
            updateLotteryResults();
            checkWinningNumbers();
            updateUserManagementDisplay();
            
            const timeDisplay = nextDrawTime === '09:30' ? 'မနက် 9:30' : 
                               nextDrawTime === '14:00' ? 'နေ့လည် 2:00' : 'ညနေ 4:30';
            
            alert(`🎉 ${user.name} အနိုင်ရပြီ!\n\n` +
                  `ထီရလဒ်: ${winningNumber} (${timeDisplay})\n` +
                  `အနိုင်ရငွေ: ${totalWinnings.toLocaleString()} ကျပ်\n` +
                  `လက်ကျန်ငွေ: ${user.balance.toLocaleString()} ကျပ်`);
        }

        function makeAllUsersWin() {
            if (!confirm('အကောင့်အားလုံး အနိုင်ရစေမှာ သေချာပါသလား?')) return;
            
            const regularUsers = users.filter(user => user.type !== 'admin');
            let winCount = 0;
            
            // Clear all results first
            todayResults = {
                '09:30': null,
                '14:00': null,
                '16:30': null
            };
            
            regularUsers.forEach((user, index) => {
                // Find user's latest approved bet
                const userBets = history.filter(item => 
                    item.user && item.user.phone === user.phone && item.status === 'အောင်မြင်ပါသည်'
                );
                
                if (userBets.length > 0 && userBets[0].bets.length > 0) {
                    const latestBet = userBets[0];
                    const winningNumber = latestBet.bets[0].number;
                    
                    // Set result for available draw time
                    const drawTimes = ['09:30', '14:00', '16:30'];
                    const drawTime = drawTimes[index % 3];
                    
                    if (!todayResults[drawTime]) {
                        todayResults[drawTime] = winningNumber;
                        
                        // Calculate winnings
                        const totalWinnings = latestBet.bets.reduce((sum, bet) => {
                            if (bet.number === winningNumber) {
                                return sum + (bet.amount * 80);
                            }
                            return sum;
                        }, 0);
                        
                        user.balance += totalWinnings;
                        winCount++;
                    }
                }
            });
            
            // Update current user display if needed
            if (currentUser && currentUser.type !== 'admin') {
                const updatedUser = users.find(u => u.phone === currentUser.phone);
                if (updatedUser) {
                    currentUser.balance = updatedUser.balance;
                    updateUserDisplay();
                }
            }
            
            // Save changes to localStorage
            saveUsers();
            saveLotteryResults();
            
            // Update displays
            updateLotteryResults();
            checkWinningNumbers();
            updateUserManagementDisplay();
            
            alert(`🎉 အောင်မြင်ပါပြီ!\n\n${winCount} ယောက် အနိုင်ရပြီးပါပြီ!\nထီရလဒ်များ အလိုအလျောက် သတ်မှတ်ပေးပြီးပါပြီ။`);
        }

        function resetAllUserBalances() {
            if (!confirm('အကောင့်အားလုံး၏ လက်ကျန်ငွေ 0 ကျပ် ပြန်လုပ်မှာ သေချာပါသလား?')) return;
            
            users.forEach(user => {
                if (user.type !== 'admin') {
                    user.balance = 0;
                }
            });
            
            // Update current user display if needed
            if (currentUser && currentUser.type !== 'admin') {
                currentUser.balance = 0;
                updateUserDisplay();
            }
            
            saveUsers(); // Save to localStorage
            updateUserManagementDisplay();
            alert('အကောင့်အားလုံး၏ လက်ကျန်ငွေ 0 ကျပ် ပြန်လုပ်ပြီးပါပြီ!');
        }

        // Event listeners
        document.getElementById('addBetBtn').addEventListener('click', addBet);
        
        document.getElementById('numberInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('amountInput').focus();
            }
        });
        
        document.getElementById('amountInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addBet();
            }
        });

        document.getElementById('payNowBtn').addEventListener('click', function() {
            if (betList.length === 0) {
                alert('ထီထိုးပါ');
                return;
            }
            
            // Check if user has sufficient balance
            if (!currentUser) {
                alert('အကောင့်ဝင်ရောက်ပါ');
                return;
            }

            if (currentUser.balance < totalAmount) {
                alert(`လက်ကျန်ငွေ မလုံလောက်ပါ!\nလိုအပ်သော ငွေ: ${totalAmount.toLocaleString()} ကျပ်\nလက်ကျန်ငွေ: ${currentUser.balance.toLocaleString()} ကျပ်\n\n💰 ငွေသွင်း ခလုတ်ကို နှိပ်ပြီး ငွေဖြည့်သွင်းပါ`);
                return;
            }

            // Confirm bet placement
            if (confirm(`ထီထိုးမှု အတည်ပြုပါ\n\nစုစုပေါင်း: ${totalAmount.toLocaleString()} ကျပ်\nလက်ကျန်ငွေ: ${(currentUser.balance - totalAmount).toLocaleString()} ကျပ် ကျန်ရှိမည်\n\nထီထိုးမှာ သေချာပါသလား?`)) {
                // Deduct balance
                currentUser.balance -= totalAmount;
                
                // Update user in users array
                const user = users.find(u => u.phone === currentUser.phone);
                if (user) {
                    user.balance = currentUser.balance;
                }
                
                saveUsers(); // Save to localStorage
                updateUserDisplay();
                
                // Add to history
                addToHistory(betList, totalAmount, 'အောင်မြင်ပါသည်');
                
                // Reset game
                betList = [];
                updateBetDisplay();
                updateTotal();
                updatePayButton();
                
                // Show success message
                alert(`ထီထိုးမှု အောင်မြင်ပါသည်!\n\nငွေပမာဏ: ${totalAmount.toLocaleString()} ကျပ်\nလက်ကျန်ငွေ: ${currentUser.balance.toLocaleString()} ကျပ်\n\n🍀 ကံကောင်းပါစေ!`);
            }
        });

        // Payment system variables
        let selectedPaymentMethod = null;
        let selectedWithdrawMethod = null;

        // Payment method data
        const paymentMethods = {
            wavepay: {
                name: 'Wave Pay',
                icon: '🌊',
                color: 'from-blue-500 to-blue-600',
                phone: '09123456789',
                instructions: [
                    '1. Wave Pay App ကို ဖွင့်ပါ',
                    '2. "Send Money" ကို နှိပ်ပါ',
                    '3. ဖုန်းနံပါတ်: 09123456789',
                    '4. အမည်: Lottery Admin',
                    '5. ငွေပမာဏ ထည့်ပြီး Send နှိပ်ပါ',
                    '6. Transaction ID ကို မှတ်သားပါ'
                ]
            },
            kpay: {
                name: 'K Pay',
                icon: '💜',
                color: 'from-purple-500 to-purple-600',
                phone: '09987654321',
                instructions: [
                    '1. K Pay App ကို ဖွင့်ပါ',
                    '2. "Transfer" ကို နှိပ်ပါ',
                    '3. ဖုန်းနံပါတ်: 09987654321',
                    '4. အမည်: Lottery System',
                    '5. ငွေပမာဏ ထည့်ပြီး Transfer နှိပ်ပါ',
                    '6. Reference Number ကို မှတ်သားပါ'
                ]
            }
        };

        // Deposit/Withdraw Event Listeners
        document.getElementById('depositBtn').addEventListener('click', function() {
            document.getElementById('depositModal').classList.remove('hidden');
            document.getElementById('depositModal').classList.add('flex');
            resetPaymentSelection();
        });

        document.getElementById('withdrawBtn').addEventListener('click', function() {
            if (currentUser) {
                document.getElementById('withdrawBalance').textContent = currentUser.balance.toLocaleString() + ' ကျပ်';
            }
            document.getElementById('withdrawModal').classList.remove('hidden');
            document.getElementById('withdrawModal').classList.add('flex');
            resetWithdrawSelection();
        });

        document.getElementById('closeDepositModal').addEventListener('click', function() {
            document.getElementById('depositModal').classList.add('hidden');
            document.getElementById('depositModal').classList.remove('flex');
            resetDepositForm();
        });

        document.getElementById('closeWithdrawModal').addEventListener('click', function() {
            document.getElementById('withdrawModal').classList.add('hidden');
            document.getElementById('withdrawModal').classList.remove('flex');
            resetWithdrawForm();
        });

        document.getElementById('cancelDeposit').addEventListener('click', function() {
            document.getElementById('depositModal').classList.add('hidden');
            document.getElementById('depositModal').classList.remove('flex');
            resetDepositForm();
        });

        document.getElementById('cancelWithdraw').addEventListener('click', function() {
            document.getElementById('withdrawModal').classList.add('hidden');
            document.getElementById('withdrawModal').classList.remove('flex');
            resetWithdrawForm();
        });

        // Payment method selection
        document.getElementById('selectWavePay').addEventListener('click', function() {
            selectPaymentMethod('wavepay');
        });

        document.getElementById('selectKPay').addEventListener('click', function() {
            selectPaymentMethod('kpay');
        });

        // Withdraw method selection
        document.getElementById('selectWavePayWithdraw').addEventListener('click', function() {
            selectWithdrawMethod('wavepay');
        });

        document.getElementById('selectKPayWithdraw').addEventListener('click', function() {
            selectWithdrawMethod('kpay');
        });

        // Payment modal event listeners
        document.getElementById('closePaymentModal').addEventListener('click', function() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').classList.remove('flex');
            resetPaymentModal();
        });

        document.getElementById('cancelPayment').addEventListener('click', function() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').classList.remove('flex');
            resetPaymentModal();
        });

        // Screenshot upload functionality
        document.getElementById('uploadArea').addEventListener('click', function() {
            document.getElementById('screenshotInput').click();
        });

        document.getElementById('screenshotInput').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                document.getElementById('uploadedFile').classList.remove('hidden');
                validatePaymentForm();
            }
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files && files[0] && files[0].type.startsWith('image/')) {
                document.getElementById('screenshotInput').files = files;
                document.getElementById('uploadedFile').classList.remove('hidden');
                validatePaymentForm();
            }
        });

        // Transaction ID validation
        document.getElementById('transactionId').addEventListener('input', function() {
            validatePaymentForm();
        });

        // Submit payment
        document.getElementById('submitPayment').addEventListener('click', function() {
            const amount = parseInt(document.getElementById('paymentAmount').textContent.replace(/[^\d]/g, ''));
            const transactionId = document.getElementById('transactionId').value.trim();
            const hasScreenshot = document.getElementById('screenshotInput').files.length > 0;
            
            if (!transactionId) {
                alert('Transaction ID ထည့်ပါ');
                return;
            }

            if (!currentUser) {
                alert('အကောင့်ဝင်ရောက်ပါ');
                return;
            }

            // Add to transaction history for admin approval (don't add to balance yet)
            const details = {
                transactionId: transactionId,
                screenshot: hasScreenshot,
                paymentPhone: paymentMethods[selectedPaymentMethod].phone
            };
            
            addTransactionToHistory('deposit', amount, selectedPaymentMethod, details, 'လုပ်ဆောင်နေဆဲ');

            // Close modals
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').classList.remove('flex');
            document.getElementById('depositModal').classList.add('hidden');
            document.getElementById('depositModal').classList.remove('flex');

            resetDepositForm();
            resetPaymentModal();

            const methodName = paymentMethods[selectedPaymentMethod].name;
            alert(`${methodName} ငွေသွင်းတောင်းဆိုမှု ပေးပို့ပြီးပါပြီ!\n\nငွေပမာဏ: ${amount.toLocaleString()} ကျပ်\nTransaction ID: ${transactionId}\n\n⏳ Admin မှ အတည်ပြုပြီးမှ လက်ကျန်ငွေ ထည့်ပေးပါမည်!\n\n📱 History တွင် Status ကြည့်နိုင်ပါသည်`);
        });

        // Helper functions
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update button styles
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'border-purple-500', 'bg-blue-100', 'bg-purple-100');
                btn.classList.add('border-gray-200');
            });
            
            const selectedBtn = method === 'wavepay' ? 
                document.getElementById('selectWavePay') : 
                document.getElementById('selectKPay');
            
            selectedBtn.classList.remove('border-gray-200');
            selectedBtn.classList.add(method === 'wavepay' ? 'border-blue-500' : 'border-purple-500');
            selectedBtn.classList.add(method === 'wavepay' ? 'bg-blue-100' : 'bg-purple-100');
            
            validateDepositForm();
        }

        function selectWithdrawMethod(method) {
            selectedWithdrawMethod = method;
            
            // Update button styles
            document.querySelectorAll('.withdraw-method-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'border-purple-500', 'bg-blue-100', 'bg-purple-100');
                btn.classList.add('border-gray-200');
            });
            
            const selectedBtn = method === 'wavepay' ? 
                document.getElementById('selectWavePayWithdraw') : 
                document.getElementById('selectKPayWithdraw');
            
            selectedBtn.classList.remove('border-gray-200');
            selectedBtn.classList.add(method === 'wavepay' ? 'border-blue-500' : 'border-purple-500');
            selectedBtn.classList.add(method === 'wavepay' ? 'bg-blue-100' : 'bg-purple-100');
            
            validateWithdrawForm();
        }

        function validateDepositForm() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            const confirmBtn = document.getElementById('confirmDeposit');
            
            if (amount >= 1000 && selectedPaymentMethod) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function validateWithdrawForm() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const accountNumber = document.getElementById('withdrawAccountNumber').value.trim();
            const accountName = document.getElementById('withdrawAccountName').value.trim();
            const confirmBtn = document.getElementById('confirmWithdraw');
            
            if (amount >= 1000 && currentUser && amount <= currentUser.balance && 
                selectedWithdrawMethod && accountNumber && accountName) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function validatePaymentForm() {
            const transactionId = document.getElementById('transactionId').value.trim();
            const submitBtn = document.getElementById('submitPayment');
            
            if (transactionId.length >= 5) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function resetPaymentSelection() {
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'border-purple-500', 'bg-blue-100', 'bg-purple-100');
                btn.classList.add('border-gray-200');
            });
        }

        function resetWithdrawSelection() {
            selectedWithdrawMethod = null;
            document.querySelectorAll('.withdraw-method-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'border-purple-500', 'bg-blue-100', 'bg-purple-100');
                btn.classList.add('border-gray-200');
            });
        }

        function resetDepositForm() {
            document.getElementById('depositAmount').value = '';
            resetPaymentSelection();
            validateDepositForm();
        }

        function resetWithdrawForm() {
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawAccountNumber').value = '';
            document.getElementById('withdrawAccountName').value = '';
            resetWithdrawSelection();
            validateWithdrawForm();
        }

        function resetPaymentModal() {
            document.getElementById('transactionId').value = '';
            document.getElementById('screenshotInput').value = '';
            document.getElementById('uploadedFile').classList.add('hidden');
            validatePaymentForm();
        }

        // Deposit amount validation
        document.getElementById('depositAmount').addEventListener('input', function() {
            validateDepositForm();
        });

        // Withdraw amount validation
        document.getElementById('withdrawAmount').addEventListener('input', function() {
            validateWithdrawForm();
        });

        // Withdraw account validation
        document.getElementById('withdrawAccountNumber').addEventListener('input', function() {
            validateWithdrawForm();
        });

        document.getElementById('withdrawAccountName').addEventListener('input', function() {
            validateWithdrawForm();
        });

        // Confirm deposit
        document.getElementById('confirmDeposit').addEventListener('click', function() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            if (!amount || amount < 1000) {
                alert('အနည်းဆုံး ၁၀၀၀ ကျပ် ထည့်ပါ');
                return;
            }

            if (!selectedPaymentMethod) {
                alert('ငွေပေးချေမှု နည်းလမ်း ရွေးချယ်ပါ');
                return;
            }

            if (!currentUser) {
                alert('အကောင့်ဝင်ရောက်ပါ');
                return;
            }

            // Show payment processing modal
            showPaymentModal(amount);
        });

        // Confirm withdraw
        document.getElementById('confirmWithdraw').addEventListener('click', function() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const accountNumber = document.getElementById('withdrawAccountNumber').value.trim();
            const accountName = document.getElementById('withdrawAccountName').value.trim();
            
            if (!amount || amount < 1000) {
                alert('အနည်းဆုံး ၁၀၀၀ ကျပ် ထည့်ပါ');
                return;
            }

            if (!selectedWithdrawMethod) {
                alert('ငွေထုတ်မည့် နည်းလမ်း ရွေးချယ်ပါ');
                return;
            }

            if (!accountNumber || !accountName) {
                alert('အကောင့်နံပါတ်နှင့် အမည် ထည့်ပါ');
                return;
            }

            if (!currentUser) {
                alert('အကောင့်ဝင်ရောက်ပါ');
                return;
            }

            if (amount > currentUser.balance) {
                alert('လက်ကျန်ငွေ မလုံလောက်ပါ');
                return;
            }

            // Confirm withdrawal
            const methodName = paymentMethods[selectedWithdrawMethod].name;
            if (confirm(`ငွေထုတ်မှု အတည်ပြုပါ\n\nနည်းလမ်း: ${methodName}\nအကောင့်: ${accountNumber}\nအမည်: ${accountName}\nငွေပမာဏ: ${amount.toLocaleString()} ကျပ်\n\nငွေထုတ်မှာ သေချာပါသလား?`)) {
                
                // Deduct from balance first (will be refunded if rejected)
                currentUser.balance -= amount;
                const user = users.find(u => u.phone === currentUser.phone);
                if (user) {
                    user.balance = currentUser.balance;
                }
                saveUsers(); // Save to localStorage
                updateUserDisplay();

                // Add to transaction history for admin approval
                const details = {
                    accountNumber: accountNumber,
                    accountName: accountName
                };
                
                addTransactionToHistory('withdrawal', amount, selectedWithdrawMethod, details, 'လုပ်ဆောင်နေဆဲ');

                // Close modal
                document.getElementById('withdrawModal').classList.add('hidden');
                document.getElementById('withdrawModal').classList.remove('flex');
                resetWithdrawForm();

                alert(`${methodName} ငွေထုတ်တောင်းဆိုမှု ပေးပို့ပြီးပါပြီ!\n\nငွေပမာဏ: ${amount.toLocaleString()} ကျပ်\nအကောင့်: ${accountNumber}\nအမည်: ${accountName}\nလက်ကျန်ငွေ: ${currentUser.balance.toLocaleString()} ကျပ်\n\n⏳ Admin မှ အတည်ပြုပြီးမှ ငွေလွှဲပေးပါမည်!\n📱 History တွင် Status ကြည့်နိုင်ပါသည်\n\n⚠️ ငွေပမာဏ ယာယီ နုတ်ထားပါသည်`);
            }
        });

        // Show payment modal function
        function showPaymentModal(amount) {
            const method = paymentMethods[selectedPaymentMethod];
            
            // Update payment modal
            document.getElementById('paymentIcon').textContent = method.icon;
            document.getElementById('paymentTitle').textContent = method.name;
            document.getElementById('paymentAmount').textContent = amount.toLocaleString() + ' ကျပ်';
            
            // Update header color
            const header = document.getElementById('paymentHeader');
            header.className = `p-4 text-white text-center bg-gradient-to-r ${method.color}`;
            
            // Update instructions
            const instructionsContainer = document.getElementById('paymentInstructions');
            instructionsContainer.innerHTML = method.instructions.map(instruction => 
                `<div>${instruction}</div>`
            ).join('');
            
            // Close deposit modal and show payment modal
            document.getElementById('depositModal').classList.add('hidden');
            document.getElementById('depositModal').classList.remove('flex');
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('paymentModal').classList.add('flex');
            
            // Reset payment form
            resetPaymentModal();
        }

        document.getElementById('historyBtn').addEventListener('click', function() {
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').classList.add('flex');
        });

        document.getElementById('closeHistory').addEventListener('click', function() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').classList.remove('flex');
        });

        // Admin event listeners
        document.getElementById('adminBtn').addEventListener('click', function() {
            document.getElementById('adminModal').classList.remove('hidden');
            document.getElementById('adminModal').classList.add('flex');
        });

        document.getElementById('closeAdmin').addEventListener('click', function() {
            document.getElementById('adminModal').classList.add('hidden');
            document.getElementById('adminModal').classList.remove('flex');
            document.getElementById('adminPassword').value = '';
        });

        document.getElementById('loginAdmin').addEventListener('click', function() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') {
                document.getElementById('adminModal').classList.add('hidden');
                document.getElementById('adminModal').classList.remove('flex');
                document.getElementById('adminHistoryModal').classList.remove('hidden');
                document.getElementById('adminHistoryModal').classList.add('flex');
                document.getElementById('adminPassword').value = '';
                
                // Update all admin displays when admin panel opens
                try {
                    updateUserManagementDisplay();
                    updateAdminTransactionDisplay();
                    updateAdminHistoryDisplay();
                    updateAdminNotificationBadge();
                    updateAdminNotificationPanel();
                    updateDebugInfo();
                } catch (error) {
                    console.log('Admin panel update error:', error);
                }
            } else {
                alert('Wrong password!');
            }
        });

        document.getElementById('closeAdminHistory').addEventListener('click', function() {
            document.getElementById('adminHistoryModal').classList.add('hidden');
            document.getElementById('adminHistoryModal').classList.remove('flex');
        });

        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginAdmin').click();
            }
        });

        // Admin notification event listeners
        document.getElementById('adminBtn').addEventListener('click', function() {
            // Check if notification panel is open
            const notificationPanel = document.getElementById('adminNotificationPanel');
            if (!notificationPanel.classList.contains('hidden')) {
                // Close notification panel
                notificationPanel.classList.add('hidden');
                return;
            }
            
            // If admin is logged in, show notification panel first
            if (currentUser && currentUser.type === 'admin') {
                notificationPanel.classList.remove('hidden');
                updateAdminNotificationPanel();
            } else {
                // Show admin login modal
                document.getElementById('adminModal').classList.remove('hidden');
                document.getElementById('adminModal').classList.add('flex');
            }
        });

        document.getElementById('closeNotificationPanel').addEventListener('click', function() {
            document.getElementById('adminNotificationPanel').classList.add('hidden');
        });

        document.getElementById('clearAllNotifications').addEventListener('click', function() {
            clearAllNotifications();
        });

        // Click outside to close notification panel
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('adminNotificationPanel');
            const adminBtn = document.getElementById('adminBtn');
            
            if (!panel.contains(e.target) && !adminBtn.contains(e.target) && !panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
            }
        });

        // Lottery Results System
        const drawTimes = [
            { time: '09:30', id: 'result930', name: 'မနက်', color: 'text-blue-600' },
            { time: '14:00', id: 'result200', name: 'နေ့လည်', color: 'text-green-600' },
            { time: '16:30', id: 'result430', name: 'ညနေ', color: 'text-purple-600' }
        ];

        let todayResults = {
            '09:30': null,
            '14:00': null,
            '16:30': null
        };

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('my-MM', options);
        }

        function generateRandomResult() {
            return String(Math.floor(Math.random() * 100)).padStart(2, '0');
        }

        function updateLotteryResults() {
            drawTimes.forEach(draw => {
                const resultElement = document.getElementById(draw.id);
                
                if (todayResults[draw.time]) {
                    // Display admin-set result with animation
                    resultElement.textContent = todayResults[draw.time];
                    resultElement.className = `text-3xl font-bold ${draw.color} animate-pulse`;
                    
                    // Add celebration effect
                    setTimeout(() => {
                        resultElement.classList.remove('animate-pulse');
                        resultElement.classList.add('animate-bounce-slow');
                    }, 1000);
                    
                    // Show winning indicator
                    const parentDiv = resultElement.parentElement;
                    if (!parentDiv.querySelector('.winning-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'winning-badge text-xs bg-green-500 text-white px-2 py-1 rounded-full mt-2 animate-pulse';
                        badge.textContent = '🎉 ထွက်ပြီး';
                        parentDiv.appendChild(badge);
                    }
                } else {
                    // Show waiting for admin to set result
                    resultElement.textContent = 'မထွက်သေး';
                    resultElement.className = 'text-3xl font-bold text-gray-400';
                    
                    // Remove winning badge if exists
                    const parentDiv = resultElement.parentElement;
                    const existingBadge = parentDiv.querySelector('.winning-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                }
            });
            
            // Check and notify users of their winnings
            checkAndNotifyWinnings();
        }

        function updateNextDrawTime() {
            const now = new Date();
            const currentTime = now.getHours() * 100 + now.getMinutes();
            
            let nextDraw = null;
            
            for (let draw of drawTimes) {
                const drawTime = parseInt(draw.time.replace(':', ''));
                if (currentTime < drawTime) {
                    nextDraw = draw;
                    break;
                }
            }
            
            const nextDrawElement = document.getElementById('nextDrawTime');
            
            if (nextDraw) {
                const drawHour = Math.floor(parseInt(nextDraw.time.replace(':', '')) / 100);
                const drawMinute = parseInt(nextDraw.time.replace(':', '')) % 100;
                const drawDate = new Date();
                drawDate.setHours(drawHour, drawMinute, 0, 0);
                
                const timeDiff = drawDate - now;
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                if (timeDiff > 0) {
                    nextDrawElement.textContent = `${nextDraw.name} ${nextDraw.time} (${hours}နာရီ ${minutes}မိနစ် ကျန်)`;
                } else {
                    nextDrawElement.textContent = `${nextDraw.name} ${nextDraw.time} - ထွက်နေပြီ`;
                }
            } else {
                // All draws for today are done
                nextDrawElement.textContent = 'ယနေ့ ထီများ အားလုံး ထွက်ပြီးပါပြီ';
            }
        }

        // Check for winning numbers
        function checkWinningNumbers() {
            const completedDraws = Object.entries(todayResults).filter(([time, result]) => result !== null);
            
            if (completedDraws.length === 0) return;
            
            // Check user's history for winning bets
            history.forEach(historyItem => {
                if (historyItem.status === 'အောင်မြင်ပါသည်') {
                    historyItem.bets.forEach(bet => {
                        completedDraws.forEach(([time, result]) => {
                            if (bet.number === result) {
                                // Mark as winner (this is just for display, real system would handle payouts)
                                bet.isWinner = true;
                                bet.winningDraw = time;
                                bet.winAmount = bet.amount * 80; // 80x multiplier
                            }
                        });
                    });
                }
            });
            
            updateHistoryDisplay();
        }

        // Check and notify users of their winnings
        function checkAndNotifyWinnings() {
            if (!currentUser) return;
            
            const completedDraws = Object.entries(todayResults).filter(([time, result]) => result !== null);
            if (completedDraws.length === 0) return;
            
            // Check current user's approved bets for winnings
            const userWinnings = [];
            history.forEach(historyItem => {
                if (historyItem.status === 'အောင်မြင်ပါသည်' && 
                    historyItem.user && historyItem.user.phone === currentUser.phone) {
                    
                    historyItem.bets.forEach(bet => {
                        completedDraws.forEach(([time, result]) => {
                            if (bet.number === result && !bet.notified) {
                                const winAmount = bet.amount * 80;
                                userWinnings.push({
                                    number: bet.number,
                                    betAmount: bet.amount,
                                    winAmount: winAmount,
                                    drawTime: time
                                });
                                bet.notified = true; // Mark as notified to avoid duplicate notifications
                            }
                        });
                    });
                }
            });
            
            // Show winning notification
            if (userWinnings.length > 0) {
                const totalWinnings = userWinnings.reduce((sum, win) => sum + win.winAmount, 0);
                
                // Add winnings to user balance
                currentUser.balance += totalWinnings;
                const user = users.find(u => u.phone === currentUser.phone);
                if (user) {
                    user.balance = currentUser.balance;
                }
                saveUsers(); // Save to localStorage
                updateUserDisplay();
                
                // Create winning notification
                let message = '🎉🎉🎉 ဂုဏ်ယူပါတယ်! သင် အနိုင်ရပါပြီ! 🎉🎉🎉\n\n';
                userWinnings.forEach(win => {
                    const timeDisplay = win.drawTime === '09:30' ? 'မနက် 9:30' : 
                                      win.drawTime === '14:00' ? 'နေ့လည် 2:00' : 'ညနေ 4:30';
                    message += `🎯 နံပါတ်: ${win.number} (${timeDisplay})\n`;
                    message += `💰 ထိုးငွေ: ${win.betAmount.toLocaleString()} ကျပ်\n`;
                    message += `🏆 အနိုင်ရငွေ: ${win.winAmount.toLocaleString()} ကျပ်\n\n`;
                });
                message += `💵 စုစုပေါင်း အနိုင်ရငွေ: ${totalWinnings.toLocaleString()} ကျပ်\n`;
                message += `💳 လက်ကျန်ငွေ: ${currentUser.balance.toLocaleString()} ကျပ်`;
                
                // Show celebration alert
                setTimeout(() => {
                    alert(message);
                }, 1500);
            }
        }

        // Admin lottery control functions
        function setLotteryResult(time, inputId) {
            try {
                const input = document.getElementById(inputId);
                if (!input) {
                    alert('Input field not found!');
                    return;
                }
                
                const number = input.value.trim();
                
                // Validation
                if (!number || number.length !== 2 || isNaN(parseInt(number))) {
                    alert('နံပါတ် ၂ လုံး ရိုက်ထည့်ပါ (00-99)');
                    input.focus();
                    return;
                }
                
                const numValue = parseInt(number);
                if (numValue < 0 || numValue > 99) {
                    alert('နံပါတ် 00 မှ 99 အတွင်း ရိုက်ထည့်ပါ');
                    input.focus();
                    return;
                }
                
                const formattedNumber = String(numValue).padStart(2, '0');
                
                // Set the result
                todayResults[time] = formattedNumber;
                
                // Save to localStorage immediately
                try {
                    localStorage.setItem('lotteryResults', JSON.stringify(todayResults));
                    localStorage.setItem('lotteryResultsDate', new Date().toDateString());
                } catch (e) {
                    console.log('Save error:', e);
                }
                
                // Update display immediately
                updateLotteryResults();
                checkWinningNumbers();
                
                // Clear input
                input.value = '';
                
                // Show success message
                const timeDisplay = time === '09:30' ? 'မနက် 9:30' : 
                                   time === '14:00' ? 'နေ့လည် 2:00' : 'ညနေ 4:30';
                
                alert(`✅ အောင်မြင်ပါပြီ!\n\n${timeDisplay} ထီရလဒ်: ${formattedNumber}\n\n🎰 User များ ချက်ချင်း မြင်ရပါပြီ!\n💰 အနိုင်ရသူများ အလိုအလျောက် ငွေရရှိပါမည်!`);
                
                // Process winnings immediately
                processWinnings(time, formattedNumber);
                
            } catch (error) {
                console.log('Set lottery result error:', error);
                alert('Error setting result. Please try again.');
            }
        }
        
        // Broadcast lottery result to all users (simulate real-time update)
        function broadcastLotteryResult(time, number) {
            // In a real application, this would use WebSocket or Server-Sent Events
            // For demo purposes, we'll just trigger immediate UI updates
            
            // Create a visual notification for users
            if (currentUser && currentUser.type !== 'admin') {
                const timeDisplay = time === '09:30' ? 'မနက် 9:30' : 
                                   time === '14:00' ? 'နေ့လည် 2:00' : 'ညနေ 4:30';
                
                // Show a temporary notification banner
                showLotteryNotification(`🎰 ${timeDisplay} ထီရလဒ် ထွက်ပါပြီ: ${number}`, 'success');
            }
        }

        // Show lottery notification banner
        function showLotteryNotification(message, type = 'info') {
            // Remove existing notification if any
            const existingNotification = document.getElementById('lotteryNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification banner
            const notification = document.createElement('div');
            notification.id = 'lotteryNotification';
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-bold animate-bounce ${
                type === 'success' ? 'bg-green-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translate(-50%, -100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // Process winnings when lottery result is set
        function processWinnings(drawTime, winningNumber) {
            try {
                let totalWinners = 0;
                let totalWinAmount = 0;
                
                // Process all approved bets
                history.forEach(historyItem => {
                    if (historyItem.status === 'အောင်မြင်ပါသည်') {
                        historyItem.bets.forEach(bet => {
                            if (bet.number === winningNumber && !bet.processed) {
                                // Mark as winner
                                bet.isWinner = true;
                                bet.winningDraw = drawTime;
                                bet.winAmount = bet.amount * 80; // 80x multiplier
                                bet.processed = true; // Prevent double processing
                                
                                // Add winnings to user balance
                                if (historyItem.user) {
                                    const user = users.find(u => u.phone === historyItem.user.phone);
                                    if (user) {
                                        user.balance += bet.winAmount;
                                        totalWinners++;
                                        totalWinAmount += bet.winAmount;
                                        
                                        // Update current user display if needed
                                        if (currentUser && currentUser.phone === user.phone) {
                                            currentUser.balance = user.balance;
                                            updateUserDisplay();
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Save all changes
                saveUsers();
                saveHistory();
                
                // Update displays
                updateHistoryDisplay();
                updateUserManagementDisplay();
                
                // Show summary
                if (totalWinners > 0) {
                    alert(`🎉 အနိုင်ရမှု အချက်အလက်များ:\n\n` +
                          `🏆 အနိုင်ရသူ: ${totalWinners} ယောက်\n` +
                          `💰 စုစုပေါင်း ပေးငွေ: ${totalWinAmount.toLocaleString()} ကျပ်\n` +
                          `🎯 အနိုင်ရနံပါတ်: ${winningNumber}\n\n` +
                          `✅ အားလုံး အလိုအလျောက် လက်ကျန်ငွေထဲ ထည့်ပေးပြီးပါပြီ!`);
                } else {
                    alert(`📊 ရလဒ်: ${winningNumber}\n\n🎯 ဤနံပါတ် ထိုးထားသူ မရှိပါ\n💰 ပေးငွေ: 0 ကျပ်`);
                }
                
            } catch (error) {
                console.log('Process winnings error:', error);
                alert('Error processing winnings. Please check manually.');
            }
        }

        function clearAllResults() {
            if (confirm('ထီရလဒ် အားလုံး ရှင်းလင်းမှာ သေချာပါသလား?\n\n⚠️ ဤလုပ်ဆောင်ချက်ကို ပြန်ပြင်၍ မရပါ!')) {
                try {
                    todayResults = {
                        '09:30': null,
                        '14:00': null,
                        '16:30': null
                    };
                    
                    // Reset all bet processing flags
                    history.forEach(historyItem => {
                        historyItem.bets.forEach(bet => {
                            bet.isWinner = false;
                            bet.winningDraw = null;
                            bet.winAmount = 0;
                            bet.processed = false;
                        });
                    });
                    
                    // Save to localStorage immediately
                    try {
                        localStorage.setItem('lotteryResults', JSON.stringify(todayResults));
                        localStorage.setItem('lotteryResultsDate', new Date().toDateString());
                        saveHistory();
                    } catch (e) {
                        console.log('Save error:', e);
                    }
                    
                    // Update display
                    updateLotteryResults();
                    updateHistoryDisplay();
                    
                    // Clear admin inputs
                    try {
                        document.getElementById('admin930').value = '';
                        document.getElementById('admin200').value = '';
                        document.getElementById('admin430').value = '';
                    } catch (e) {
                        console.log('Clear inputs error:', e);
                    }
                    
                    // Reset winning badges
                    document.querySelectorAll('.winning-badge').forEach(badge => badge.remove());
                    
                    alert('✅ ထီရလဒ် အားလုံး ရှင်းလင်းပြီးပါပြီ!\n\n🔄 အားလုံး ပြန်လည် သတ်မှတ်နိုင်ပါပြီ!');
                    
                } catch (error) {
                    console.log('Clear results error:', error);
                    alert('Error clearing results. Please refresh and try again.');
                }
            }
        }

        // Auto-generate results for demo (disabled - now admin controlled)
        function simulateDrawResults() {
            // Disabled - results are now controlled by admin only
            // Admin must manually set results using the admin panel
        }

        // Real-time lottery results system using localStorage
        function saveLotteryResults() {
            localStorage.setItem('lotteryResults', JSON.stringify(todayResults));
            localStorage.setItem('lotteryResultsDate', new Date().toDateString());
            syncDataToServer(); // Sync to all devices
        }

        function loadLotteryResults() {
            const savedDate = localStorage.getItem('lotteryResultsDate');
            const today = new Date().toDateString();
            
            if (savedDate === today) {
                const savedResults = localStorage.getItem('lotteryResults');
                if (savedResults) {
                    todayResults = JSON.parse(savedResults);
                }
            } else {
                // New day, reset results
                todayResults = {
                    '09:30': null,
                    '14:00': null,
                    '16:30': null
                };
                saveLotteryResults();
            }
        }

        // MASTER ADMIN CONTROL REAL-TIME SYSTEM
        // All devices instantly respond to admin commands
        function setupRealTimeUpdates() {
            // PRIORITY LISTENER: Master Admin Control
            window.addEventListener('storage', function(e) {
                try {
                    // INSTANT RESPONSE to Master Control changes
                    if (e.key === 'LOTTERY_MASTER_CONTROL') {
                        console.log('🔥 MASTER CONTROL UPDATE RECEIVED');
                        
                        // Immediately load all data from master control
                        loadAllDataFromSync();
                        
                        // Force update ALL displays instantly
                        updateLotteryResults();
                        checkWinningNumbers();
                        updateHistoryDisplay();
                        updateUserDisplay();
                        
                        // Update admin displays if admin is logged in
                        if (currentUser && currentUser.type === 'admin') {
                            updateUserManagementDisplay();
                            updateAdminTransactionDisplay();
                            updateAdminHistoryDisplay();
                            updateAdminNotificationBadge();
                            updateAdminNotificationPanel();
                        }
                        
                        // Show instant notification to users
                        if (currentUser && currentUser.type !== 'admin') {
                            showLotteryNotification('⚡ Admin Control Update - ချက်ချင်း အပ်ဒိတ်!', 'success');
                        }
                        
                        return; // Master control handled, skip other checks
                    }
                    
                    // Handle other storage events
                    if (e.key === 'lotteryResults' || e.key === 'lotterySync') {
                        loadAllDataFromSync();
                        updateLotteryResults();
                        checkWinningNumbers();
                        updateHistoryDisplay();
                        updateUserDisplay();
                        
                        if (currentUser && currentUser.type === 'admin') {
                            updateUserManagementDisplay();
                            updateAdminTransactionDisplay();
                            updateAdminHistoryDisplay();
                            updateAdminNotificationBadge();
                        }
                        
                        if (currentUser && currentUser.type !== 'admin') {
                            showLotteryNotification('🔄 အချက်အလက် အပ်ဒိတ် ရရှိပါပြီ!', 'success');
                        }
                    }
                    
                    // Handle specific data updates
                    if (e.key === 'lotteryUsers') {
                        loadUsers();
                        updateUserDisplay();
                        if (currentUser && currentUser.type === 'admin') {
                            updateUserManagementDisplay();
                        }
                    }
                    
                    if (e.key === 'lotteryTransactions') {
                        loadTransactions();
                        updateHistoryDisplay();
                        if (currentUser && currentUser.type === 'admin') {
                            updateAdminTransactionDisplay();
                        }
                    }
                    
                    if (e.key === 'lotteryHistory') {
                        loadHistory();
                        updateHistoryDisplay();
                        if (currentUser && currentUser.type === 'admin') {
                            updateAdminHistoryDisplay();
                        }
                    }
                    
                    if (e.key === 'adminNotifications') {
                        loadNotifications();
                        if (currentUser && currentUser.type === 'admin') {
                            updateAdminNotificationBadge();
                            updateAdminNotificationPanel();
                        }
                    }
                } catch (error) {
                    console.log('Storage event error:', error);
                }
            });
            
            // BROADCAST CHANNEL for cross-device communication
            if (typeof BroadcastChannel !== 'undefined') {
                const adminChannel = new BroadcastChannel('lottery_admin_control');
                adminChannel.addEventListener('message', function(event) {
                    try {
                        if (event.data.type === 'ADMIN_UPDATE') {
                            console.log('📡 Broadcast Channel Update Received');
                            loadAllDataFromSync();
                            
                            // Update all displays
                            updateLotteryResults();
                            checkWinningNumbers();
                            updateHistoryDisplay();
                            updateUserDisplay();
                            
                            if (currentUser && currentUser.type === 'admin') {
                                updateUserManagementDisplay();
                                updateAdminTransactionDisplay();
                                updateAdminHistoryDisplay();
                                updateAdminNotificationBadge();
                            }
                            
                            if (currentUser && currentUser.type !== 'admin') {
                                showLotteryNotification('📡 Cross-Device Update!', 'success');
                            }
                        }
                    } catch (error) {
                        console.log('Broadcast channel error:', error);
                    }
                });
            }
            
            // SUPER AGGRESSIVE POLLING for Master Control (every 1 second)
            setInterval(() => {
                try {
                    // Store current state
                    const currentUsersState = JSON.stringify(users);
                    const currentHistoryState = JSON.stringify(history);
                    const currentTransactionsState = JSON.stringify(transactionHistory);
                    const currentResultsState = JSON.stringify(todayResults);
                    const currentNotificationsState = JSON.stringify(adminNotifications);
                    
                    // Load latest data from master control
                    loadAllDataFromSync();
                    
                    // Check for changes and update displays instantly
                    let hasChanges = false;
                    
                    if (currentUsersState !== JSON.stringify(users)) {
                        updateUserDisplay();
                        if (currentUser && currentUser.type === 'admin') {
                            updateUserManagementDisplay();
                        }
                        hasChanges = true;
                    }
                    
                    if (currentHistoryState !== JSON.stringify(history)) {
                        updateHistoryDisplay();
                        if (currentUser && currentUser.type === 'admin') {
                            updateAdminHistoryDisplay();
                        }
                        hasChanges = true;
                    }
                    
                    if (currentTransactionsState !== JSON.stringify(transactionHistory)) {
                        updateHistoryDisplay();
                        if (currentUser && currentUser.type === 'admin') {
                            updateAdminTransactionDisplay();
                        }
                        hasChanges = true;
                    }
                    
                    if (currentResultsState !== JSON.stringify(todayResults)) {
                        updateLotteryResults();
                        checkWinningNumbers();
                        hasChanges = true;
                        
                        // INSTANT lottery result notification
                        if (currentUser && currentUser.type !== 'admin') {
                            showLotteryNotification('🎰 ထီရလဒ် ထွက်ပါပြီ! (Admin Control)', 'success');
                        }
                    }
                    
                    if (currentNotificationsState !== JSON.stringify(adminNotifications)) {
                        if (currentUser && currentUser.type === 'admin') {
                            updateAdminNotificationBadge();
                            updateAdminNotificationPanel();
                        }
                        hasChanges = true;
                    }
                    
                    // Update current user balance if changed
                    if (currentUser && hasChanges) {
                        const updatedUser = users.find(u => u.phone === currentUser.phone);
                        if (updatedUser && updatedUser.balance !== currentUser.balance) {
                            currentUser.balance = updatedUser.balance;
                            updateUserDisplay();
                            
                            // Show balance update notification
                            if (currentUser.type !== 'admin') {
                                showLotteryNotification('💰 လက်ကျန်ငွေ အပ်ဒိတ်!', 'success');
                            }
                        }
                    }
                    
                } catch (error) {
                    console.log('Super polling error:', error);
                }
            }, 1000); // Check every 1 second for INSTANT updates
            
            // ULTRA FAST polling for lottery results (every 500ms)
            setInterval(() => {
                try {
                    const currentResults = JSON.stringify(todayResults);
                    
                    // Check master control first
                    const masterControl = localStorage.getItem('LOTTERY_MASTER_CONTROL');
                    if (masterControl) {
                        const masterData = JSON.parse(masterControl);
                        if (masterData.todayResults) {
                            todayResults = masterData.todayResults;
                        }
                    } else {
                        loadLotteryResults();
                    }
                    
                    const newResults = JSON.stringify(todayResults);
                    
                    if (currentResults !== newResults) {
                        updateLotteryResults();
                        checkWinningNumbers();
                        
                        // ULTRA FAST notification for lottery results
                        if (currentUser && currentUser.type !== 'admin') {
                            showLotteryNotification('⚡ ထီရလဒ် ချက်ချင်း ထွက်ပါပြီ!', 'success');
                        }
                    }
                } catch (error) {
                    console.log('Ultra fast polling error:', error);
                }
            }, 500); // Check every 500ms for ULTRA FAST lottery updates
        }

        // Initialize lottery system
        function initializeLotterySystem() {
            updateCurrentDate();
            loadLotteryResults(); // Load existing results
            updateLotteryResults();
            updateNextDrawTime();
            checkWinningNumbers();
            setupRealTimeUpdates(); // Setup real-time updates
            
            // Update every minute
            setInterval(() => {
                updateLotteryResults();
                updateNextDrawTime();
                checkWinningNumbers();
            }, 60000);
        }

        // Deposit/Withdraw Helper Functions
        function setDepositAmount(amount) {
            document.getElementById('depositAmount').value = amount;
            document.getElementById('depositAmount').dispatchEvent(new Event('input'));
        }

        function setWithdrawAmount(amount) {
            if (amount === 'all' && currentUser) {
                document.getElementById('withdrawAmount').value = currentUser.balance;
            } else {
                document.getElementById('withdrawAmount').value = amount;
            }
            document.getElementById('withdrawAmount').dispatchEvent(new Event('input'));
        }

        // Admin notification system
        function notifyAdmin(type, data) {
            const notification = {
                id: Date.now(),
                type: type,
                data: data,
                timestamp: new Date().toLocaleString('my-MM'),
                read: false
            };
            
            adminNotifications.unshift(notification);
            saveNotifications();
            updateAdminNotificationBadge();
            updateAdminNotificationPanel();
            
            // Auto-refresh admin panels if open
            updateUserManagementDisplay();
            updateAdminHistoryDisplay();
            updateAdminTransactionDisplay();
            
            // Show notification sound/visual effect
            showAdminNotificationAlert(type, data);
        }

        function showAdminNotificationAlert(type, data) {
            // Only show if user is admin
            if (!currentUser || currentUser.type !== 'admin') return;
            
            let message = '';
            let icon = '';
            
            switch(type) {
                case 'newUser':
                    message = `👤 အကောင့်အသစ်: ${data.name} (${data.phone}) - ${data.browser} on ${data.device}`;
                    icon = '👤';
                    break;
                case 'userLogin':
                    message = `🔐 Login: ${data.name} (${data.phone}) - ${data.browser} on ${data.device}`;
                    icon = '🔐';
                    break;
                case 'newTransaction':
                    const typeText = data.type === 'deposit' ? 'ငွေသွင်း' : 'ငွေထုတ်';
                    const methodIcon = data.method === 'wavepay' ? '🌊' : '💜';
                    message = `${methodIcon} ${typeText}: ${data.amount.toLocaleString()} ကျပ် - ${data.user?.name}`;
                    icon = data.type === 'deposit' ? '💰' : '🏧';
                    break;
                case 'newBet':
                    const betNumbers = data.bets.map(bet => bet.number).join(', ');
                    message = `🎰 ထီအသစ်: ${betNumbers} (${data.amount.toLocaleString()} ကျပ်) - ${data.user?.name}`;
                    icon = '🎰';
                    break;
            }
            
            // Show floating notification
            showFloatingNotification(message, icon);
        }

        function showFloatingNotification(message, icon) {
            // Remove existing notification if any
            const existingNotification = document.getElementById('floatingNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create floating notification
            const notification = document.createElement('div');
            notification.id = 'floatingNotification';
            notification.className = 'fixed top-20 right-4 bg-red-500 text-white px-4 py-3 rounded-lg shadow-2xl z-50 animate-bounce border-2 border-white';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${icon}</span>
                    <span class="font-medium text-sm">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
            
            // Make notification clickable to open admin panel
            notification.addEventListener('click', function() {
                document.getElementById('adminNotificationPanel').classList.remove('hidden');
                notification.remove();
            });
        }

        function updateAdminNotificationBadge() {
            const badge = document.getElementById('adminNotificationBadge');
            const unreadCount = adminNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function updateAdminNotificationPanel() {
            const container = document.getElementById('notificationContent');
            
            if (adminNotifications.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No notifications</p>';
                return;
            }
            
            container.innerHTML = adminNotifications.map(notification => {
                let content = '';
                let bgColor = notification.read ? 'bg-gray-50' : 'bg-blue-50';
                let borderColor = notification.read ? 'border-gray-200' : 'border-blue-300';
                
                switch(notification.type) {
                    case 'newUser':
                        content = `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">👤</span>
                                <span class="font-medium text-green-700">အကောင့်အသစ်</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                <div><strong>${notification.data.name}</strong></div>
                                <div class="text-xs text-gray-500">${notification.data.phone}</div>
                                <div class="text-xs text-blue-600 mt-1">
                                    🌐 ${notification.data.browser} | 📱 ${notification.data.device}
                                </div>
                                <div class="text-xs text-gray-500">📅 ${notification.data.registeredAt}</div>
                            </div>
                        `;
                        break;
                    case 'userLogin':
                        content = `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">🔐</span>
                                <span class="font-medium text-blue-700">User Login</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                <div><strong>${notification.data.name}</strong></div>
                                <div class="text-xs text-gray-500">${notification.data.phone}</div>
                                <div class="text-xs text-blue-600 mt-1">
                                    🌐 ${notification.data.browser} | 📱 ${notification.data.device}
                                </div>
                                <div class="text-xs text-gray-500">
                                    🕐 ${notification.data.loginTime} | 🔢 Login #${notification.data.loginCount}
                                </div>
                            </div>
                        `;
                        break;
                    case 'newTransaction':
                        const typeText = notification.data.type === 'deposit' ? 'ငွေသွင်းမှု' : 'ငွေထုတ်မှု';
                        const methodIcon = notification.data.method === 'wavepay' ? '🌊' : '💜';
                        const methodName = notification.data.method === 'wavepay' ? 'Wave Pay' : 'K Pay';
                        content = `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">${notification.data.type === 'deposit' ? '💰' : '🏧'}</span>
                                <span class="font-medium ${notification.data.type === 'deposit' ? 'text-green-700' : 'text-blue-700'}">${typeText}</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                <div><strong>${notification.data.user?.name}</strong> (${notification.data.user?.phone})</div>
                                <div class="text-xs text-gray-600">${methodIcon} ${methodName} - ${notification.data.amount.toLocaleString()} ကျပ်</div>
                            </div>
                        `;
                        break;
                    case 'newBet':
                        const betNumbers = notification.data.bets.map(bet => `${bet.number} (${bet.amount}ကျပ်)`).join(', ');
                        content = `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">🎰</span>
                                <span class="font-medium text-purple-700">ထီအသစ်</span>
                            </div>
                            <div class="text-sm text-gray-700">
                                <div><strong>${notification.data.user?.name}</strong> (${notification.data.user?.phone})</div>
                                <div class="text-xs text-gray-600">${betNumbers}</div>
                                <div class="text-xs font-medium text-green-600">စုစုပေါင်း: ${notification.data.amount.toLocaleString()} ကျပ်</div>
                            </div>
                        `;
                        break;
                }
                
                return `
                    <div class="border ${borderColor} ${bgColor} rounded-lg p-3 mb-3 cursor-pointer hover:bg-blue-100 transition-colors relative" onclick="markNotificationAsRead(${notification.id})">
                        ${content}
                        <div class="text-xs text-gray-400 mt-2">${notification.timestamp}</div>
                        ${!notification.read ? '<div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function markNotificationAsRead(id) {
            const notification = adminNotifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                saveNotifications();
                updateAdminNotificationBadge();
                updateAdminNotificationPanel();
            }
        }

        function clearAllNotifications() {
            if (confirm('အားလုံး ရှင်းလင်းမှာ သေချာပါသလား?')) {
                adminNotifications = [];
                saveNotifications();
                updateAdminNotificationBadge();
                updateAdminNotificationPanel();
            }
        }

        function saveNotifications() {
            localStorage.setItem('adminNotifications', JSON.stringify(adminNotifications));
            syncDataToServer(); // Sync to all devices
        }

        function loadNotifications() {
            const saved = localStorage.getItem('adminNotifications');
            if (saved) {
                adminNotifications = JSON.parse(saved);
            }
        }

        // Data persistence functions
        function saveUsers() {
            localStorage.setItem('lotteryUsers', JSON.stringify(users));
            syncDataToServer(); // Sync to all devices
        }

        function loadUsers() {
            const savedUsers = localStorage.getItem('lotteryUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
        }

        function saveTransactions() {
            localStorage.setItem('lotteryTransactions', JSON.stringify(transactionHistory));
            syncDataToServer(); // Sync to all devices
        }

        function loadTransactions() {
            const savedTransactions = localStorage.getItem('lotteryTransactions');
            if (savedTransactions) {
                transactionHistory = JSON.parse(savedTransactions);
            }
        }

        function saveHistory() {
            localStorage.setItem('lotteryHistory', JSON.stringify(history));
            syncDataToServer(); // Sync to all devices
        }

        function loadHistory() {
            const savedHistory = localStorage.getItem('lotteryHistory');
            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }
        }

        function initializeData() {
            try {
                // Load all data using enhanced sync system
                loadAllDataFromSync();
            } catch (error) {
                console.log('Data initialization error:', error);
                // Fallback to individual loading
                try {
                    loadUsers();
                    loadTransactions();
                    loadHistory();
                    loadLotteryResults();
                    loadNotifications();
                } catch (fallbackError) {
                    console.log('Fallback data loading error:', fallbackError);
                }
            }
        }

        // CENTRALIZED ADMIN CONTROL SYSTEM
        // All devices connect to this single admin control center
        function syncDataToServer() {
            try {
                // Create master control data with admin authority
                const masterData = {
                    // Core system data
                    users: users,
                    history: history,
                    transactionHistory: transactionHistory,
                    todayResults: todayResults,
                    adminNotifications: adminNotifications,
                    
                    // Admin control metadata
                    adminControl: {
                        lastUpdate: new Date().getTime(),
                        adminDevice: currentUser?.type === 'admin' ? getBrowserInfo() + ' on ' + getDeviceInfo() : null,
                        controlId: Date.now() + Math.random(),
                        version: '2.0'
                    },
                    
                    // Cross-device sync info
                    syncInfo: {
                        totalDevices: 0,
                        activeUsers: users.filter(u => isUserOnline(u)).length,
                        lastSync: new Date().toLocaleString('my-MM')
                    }
                };
                
                // MASTER CONTROL - Save to all possible storage locations
                localStorage.setItem('LOTTERY_MASTER_CONTROL', JSON.stringify(masterData));
                localStorage.setItem('lotterySync', JSON.stringify(masterData));
                localStorage.setItem('lotteryUsers', JSON.stringify(users));
                localStorage.setItem('lotteryTransactions', JSON.stringify(transactionHistory));
                localStorage.setItem('lotteryHistory', JSON.stringify(history));
                localStorage.setItem('lotteryResults', JSON.stringify(todayResults));
                localStorage.setItem('lotteryResultsDate', new Date().toDateString());
                localStorage.setItem('adminNotifications', JSON.stringify(adminNotifications));
                
                // BROADCAST TO ALL DEVICES - Force update across all tabs/devices
                try {
                    // Method 1: Storage Event (same origin)
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'LOTTERY_MASTER_CONTROL',
                        newValue: JSON.stringify(masterData),
                        url: window.location.href
                    }));
                    
                    // Method 2: Broadcast Channel (if supported)
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('lottery_admin_control');
                        channel.postMessage({
                            type: 'ADMIN_UPDATE',
                            data: masterData,
                            timestamp: Date.now()
                        });
                    }
                    
                    // Method 3: Multiple storage keys for redundancy
                    for (let i = 1; i <= 5; i++) {
                        localStorage.setItem(`lottery_backup_${i}`, JSON.stringify(masterData));
                    }
                    
                } catch (broadcastError) {
                    console.log('Broadcast error:', broadcastError);
                }
                
            } catch (error) {
                console.log('Master sync error:', error);
            }
        }

        // MASTER CONTROL DATA LOADING
        // All devices must obey the master admin control
        function loadAllDataFromSync() {
            try {
                // PRIORITY 1: Load from MASTER CONTROL
                const masterControl = localStorage.getItem('LOTTERY_MASTER_CONTROL');
                if (masterControl) {
                    const masterData = JSON.parse(masterControl);
                    
                    // Check if master data is valid and recent
                    const adminUpdate = masterData.adminControl?.lastUpdate || 0;
                    const currentTime = Date.now();
                    
                    // Master control is always valid (no time limit for admin control)
                    if (masterData.users) users = masterData.users;
                    if (masterData.history) history = masterData.history;
                    if (masterData.transactionHistory) transactionHistory = masterData.transactionHistory;
                    if (masterData.todayResults) todayResults = masterData.todayResults;
                    if (masterData.adminNotifications) adminNotifications = masterData.adminNotifications;
                    
                    console.log('✅ Loaded from MASTER CONTROL:', masterData.adminControl?.adminDevice || 'Unknown Admin');
                    return; // Master control loaded successfully
                }
                
                // PRIORITY 2: Load from backup sync data
                const syncData = localStorage.getItem('lotterySync');
                if (syncData) {
                    const parsed = JSON.parse(syncData);
                    
                    if (parsed.users) users = parsed.users;
                    if (parsed.history) history = parsed.history;
                    if (parsed.transactionHistory) transactionHistory = parsed.transactionHistory;
                    if (parsed.todayResults) todayResults = parsed.todayResults;
                    if (parsed.adminNotifications) adminNotifications = parsed.adminNotifications;
                    
                    console.log('✅ Loaded from backup sync data');
                    return;
                }
                
                // PRIORITY 3: Load from individual storage keys (fallback)
                loadUsers();
                loadTransactions();
                loadHistory();
                loadLotteryResults();
                loadNotifications();
                
                console.log('✅ Loaded from individual storage keys (fallback)');
                
            } catch (error) {
                console.log('Master control load error:', error);
                
                // EMERGENCY FALLBACK: Try backup storage
                try {
                    for (let i = 1; i <= 5; i++) {
                        const backup = localStorage.getItem(`lottery_backup_${i}`);
                        if (backup) {
                            const backupData = JSON.parse(backup);
                            if (backupData.users) users = backupData.users;
                            if (backupData.history) history = backupData.history;
                            if (backupData.transactionHistory) transactionHistory = backupData.transactionHistory;
                            if (backupData.todayResults) todayResults = backupData.todayResults;
                            if (backupData.adminNotifications) adminNotifications = backupData.adminNotifications;
                            console.log(`✅ Loaded from backup ${i}`);
                            return;
                        }
                    }
                } catch (backupError) {
                    console.log('Backup load error:', backupError);
                }
                
                // Final fallback to individual loading
                try {
                    loadUsers();
                    loadTransactions();
                    loadHistory();
                    loadLotteryResults();
                    loadNotifications();
                } catch (finalError) {
                    console.log('Final fallback error:', finalError);
                }
            }
        }

        // Real-time user activity tracking
        function startUserActivityTracking() {
            try {
                if (!currentUser || currentUser.type === 'admin') return;
                
                // Update user's last activity every 30 seconds
                setInterval(() => {
                    try {
                        if (currentUser && currentUser.type !== 'admin') {
                            const user = users.find(u => u.phone === currentUser.phone);
                            if (user) {
                                user.lastActivity = new Date().toLocaleString('my-MM');
                                saveUsers();
                            }
                        }
                    } catch (error) {
                        console.log('Activity tracking error:', error);
                    }
                }, 30000); // 30 seconds
                
                // Track page visibility changes
                document.addEventListener('visibilitychange', function() {
                    try {
                        if (currentUser && currentUser.type !== 'admin') {
                            const user = users.find(u => u.phone === currentUser.phone);
                            if (user) {
                                if (document.hidden) {
                                    user.lastSeen = new Date().toLocaleString('my-MM');
                                } else {
                                    user.lastActivity = new Date().toLocaleString('my-MM');
                                }
                                saveUsers();
                            }
                        }
                    } catch (error) {
                        console.log('Visibility change error:', error);
                    }
                });
            } catch (error) {
                console.log('User activity tracking initialization error:', error);
            }
        }

        // Initialize app
        function initializeApp() {
            try {
                // Initialize data first
                initializeData();
                
                // Initialize lottery system
                initializeLotterySystem();
                
                // Try to auto-login from saved session
                if (loadCurrentUser()) {
                    // User was previously logged in and session is still valid
                    showMainApp();
                    updateUserDisplay();
                } else {
                    // No valid session, show login screen
                    showLoginScreen();
                }
                
                // Initialize all displays
                updateBetDisplay();
                updateTotal();
                updatePayButton();
                updateHistoryDisplay();
                updateAdminHistoryDisplay();
                updateAdminTransactionDisplay();
                updateAdminNotificationBadge();
                updateAdminNotificationPanel();
                
                // Start user activity tracking if logged in
                if (currentUser) {
                    startUserActivityTracking();
                }
                
                // Auto-refresh admin panels every 10 seconds for real-time updates
                setInterval(() => {
                    try {
                        if (currentUser && currentUser.type === 'admin') {
                            updateUserManagementDisplay();
                            updateAdminNotificationBadge();
                        }
                    } catch (error) {
                        console.log('Admin refresh error:', error);
                    }
                }, 10000); // 10 seconds
                
            } catch (error) {
                console.log('Initialization error:', error);
                // Fallback to login screen
                showLoginScreen();
                try {
                    initializeLotterySystem();
                } catch (lotteryError) {
                    console.log('Lottery system error:', lotteryError);
                }
            }
        }

        // Enhanced initialization with cross-device sync
        function safeInitialize() {
            try {
                // Initialize data with enhanced sync system
                initializeData();
                
                // Initialize lottery display
                updateCurrentDate();
                updateLotteryResults();
                updateNextDrawTime();
                
                // Setup real-time updates immediately
                setupRealTimeUpdates();
                
                // Try to auto-login from saved session
                if (loadCurrentUser()) {
                    // User was previously logged in and session is still valid
                    showMainApp();
                    updateUserDisplay();
                    
                    // Start user activity tracking
                    startUserActivityTracking();
                    
                    // Update all displays for logged in user
                    updateHistoryDisplay();
                    updateAdminNotificationBadge();
                    
                    // If admin, update admin displays
                    if (currentUser && currentUser.type === 'admin') {
                        updateUserManagementDisplay();
                        updateAdminTransactionDisplay();
                        updateAdminHistoryDisplay();
                        updateAdminNotificationPanel();
                    }
                } else {
                    // No valid session, show login screen
                    showLoginScreen();
                }
                
                // Initialize game displays
                updateBetDisplay();
                updateTotal();
                updatePayButton();
                
                console.log('App initialized successfully with cross-device sync');
            } catch (error) {
                console.log('Safe initialization error:', error);
                // Even if there's an error, show login screen and basic functionality
                showLoginScreen();
                try {
                    updateCurrentDate();
                    updateLotteryResults();
                    setupRealTimeUpdates();
                } catch (basicError) {
                    console.log('Basic initialization error:', basicError);
                }
            }
        }

        // Debug functions for admin
        function debugShowData() {
            let data = '🔧 ADMIN DEBUG DATA:\n\n';
            
            data += `👤 CURRENT USER:\n`;
            data += currentUser ? `${currentUser.name} (${currentUser.phone}) - ${currentUser.type}\nBalance: ${currentUser.balance.toLocaleString()} ကျပ်\n\n` : 'None\n\n';
            
            data += `👥 ALL USERS (${users.length}):\n`;
            users.forEach(user => {
                data += `${user.name} (${user.phone}) - ${user.type} - ${user.balance.toLocaleString()} ကျပ်\n`;
            });
            data += '\n';
            
            data += `💰 TRANSACTIONS (${transactionHistory.length}):\n`;
            transactionHistory.slice(0, 5).forEach(t => {
                data += `${t.type} - ${t.amount.toLocaleString()} - ${t.status} - ${t.user?.name}\n`;
            });
            data += '\n';
            
            data += `🎰 LOTTERY HISTORY (${history.length}):\n`;
            history.slice(0, 5).forEach(h => {
                data += `${h.amount.toLocaleString()} ကျပ် - ${h.status} - ${h.user?.name}\n`;
            });
            data += '\n';
            
            data += `🎯 LOTTERY RESULTS:\n`;
            Object.entries(todayResults).forEach(([time, result]) => {
                data += `${time}: ${result || 'မထွက်သေး'}\n`;
            });
            
            alert(data);
        }

        function debugClearAllData() {
            if (confirm('⚠️ အားလုံး ရှင်းလင်းမှာ သေချာပါသလား?\n\nဤလုပ်ဆောင်ချက်ကို ပြန်ပြင်၍ မရပါ!')) {
                try {
                    // Clear all localStorage
                    localStorage.removeItem('lotteryUsers');
                    localStorage.removeItem('lotteryTransactions');
                    localStorage.removeItem('lotteryHistory');
                    localStorage.removeItem('lotteryResults');
                    localStorage.removeItem('lotteryResultsDate');
                    localStorage.removeItem('lotteryCurrentUser');
                    localStorage.removeItem('adminNotifications');
                    localStorage.removeItem('lotterySync');
                    
                    alert('✅ အားလုံး ရှင်းလင်းပြီးပါပြီ!\n\nPage ကို Reload လုပ်ပါ!');
                    
                } catch (error) {
                    alert('Error clearing data: ' + error.message);
                }
            }
        }

        function debugReloadPage() {
            if (confirm('Page ကို Reload လုပ်မှာ သေချာပါသလား?')) {
                window.location.reload();
            }
        }

        function debugTestTransaction() {
            if (!currentUser) {
                alert('Admin အကောင့်ဝင်ရောက်ပါ!');
                return;
            }
            
            // Create a test deposit transaction
            const testTransaction = {
                id: Date.now(),
                type: 'deposit',
                date: new Date().toLocaleString('my-MM'),
                amount: 10000,
                method: 'wavepay',
                status: 'လုပ်ဆောင်နေဆဲ',
                details: {
                    transactionId: 'TEST' + Date.now(),
                    screenshot: false
                },
                user: {
                    name: 'Test User',
                    phone: '09111111111',
                    type: 'user'
                }
            };
            
            transactionHistory.unshift(testTransaction);
            saveTransactions();
            updateAdminTransactionDisplay();
            
            alert('✅ Test Transaction ထည့်ပြီးပါပြီ!\n\nငွေသွင်း/ထုတ် အတည်ပြုရန် section တွင် ကြည့်ပါ!');
        }

        // MASTER ADMIN CONTROL FUNCTIONS
        function forceSyncAllDevices() {
            try {
                if (!currentUser || currentUser.type !== 'admin') {
                    alert('Admin access required!');
                    return;
                }
                
                // Force immediate sync to all devices
                syncDataToServer();
                
                // Clear all backup storage and force refresh
                for (let i = 1; i <= 10; i++) {
                    localStorage.setItem(`lottery_backup_${i}`, localStorage.getItem('LOTTERY_MASTER_CONTROL'));
                }
                
                // Trigger multiple storage events
                const masterData = JSON.parse(localStorage.getItem('LOTTERY_MASTER_CONTROL') || '{}');
                masterData.forceSync = Date.now();
                localStorage.setItem('LOTTERY_MASTER_CONTROL', JSON.stringify(masterData));
                
                // Broadcast to all channels
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('lottery_admin_control');
                    channel.postMessage({
                        type: 'FORCE_SYNC',
                        data: masterData,
                        timestamp: Date.now()
                    });
                }
                
                // Update admin control status
                updateAdminControlStatus();
                
                alert('🔥 FORCE SYNC COMPLETED!\n\n✅ အားလုံး device များ ချက်ချင်း အပ်ဒိတ် ဖြစ်ပါမည်!\n📡 Master Control Active\n⚡ Real-time sync enabled');
                
            } catch (error) {
                console.log('Force sync error:', error);
                alert('Force sync failed. Please try again.');
            }
        }

        function updateAdminControlStatus() {
            try {
                if (currentUser && currentUser.type === 'admin') {
                    document.getElementById('adminControlStatus').textContent = 'ACTIVE';
                    document.getElementById('adminDeviceInfo').textContent = getBrowserInfo() + ' on ' + getDeviceInfo();
                    document.getElementById('adminLastUpdate').textContent = new Date().toLocaleTimeString('my-MM');
                    document.getElementById('connectedDevices').textContent = 'All Synced';
                    document.getElementById('activeUsersCount').textContent = users.filter(u => isUserOnline(u)).length;
                }
            } catch (error) {
                console.log('Admin status update error:', error);
            }
        }

        function updateDebugInfo() {
            try {
                document.getElementById('debugCurrentUser').textContent = currentUser ? `${currentUser.name} (${currentUser.type})` : 'None';
                document.getElementById('debugTotalUsers').textContent = users.length;
                document.getElementById('debugTotalTransactions').textContent = transactionHistory.length;
                document.getElementById('debugTotalHistory').textContent = history.length;
                
                const results = Object.entries(todayResults).filter(([time, result]) => result !== null);
                document.getElementById('debugLotteryResults').textContent = results.length > 0 ? 
                    results.map(([time, result]) => `${time}:${result}`).join(', ') : 'None';
                
                // Master control status
                const masterControl = localStorage.getItem('LOTTERY_MASTER_CONTROL');
                document.getElementById('debugMasterControl').textContent = masterControl ? 'Active' : 'Inactive';
                document.getElementById('debugSyncStatus').textContent = 'Connected';
                
                // Update admin control status if admin
                if (currentUser && currentUser.type === 'admin') {
                    updateAdminControlStatus();
                }
            } catch (error) {
                console.log('Debug info update error:', error);
            }
        }

        // Initialize when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitialize);
        } else {
            safeInitialize();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f9a6076382a1b7',t:'MTc1Nzk1NTI5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAcAMCXLexHyccOCJxWGxCcqlFcVX1UlMU",
    authDomain: "lottery-web-c7a5f.firebaseapp.com",
    projectId: "lottery-web-c7a5f",
    storageBucket: "lottery-web-c7a5f.firebasestorage.app",
    messagingSenderId: "530176543902",
    appId: "1:530176543902:web:d197d6038f32631fbbbf8f",
    measurementId: "G-6E09FJ49ZX"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script></body>
</html>
